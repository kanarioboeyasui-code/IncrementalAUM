<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Factor Fund (Mobile)</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Noto Sans JP',sans-serif;background:#0b0f19;color:#e5e7eb;overflow:hidden;user-select:none;-webkit-tap-highlight-color:transparent}
    @keyframes jump{0%{transform:translate(-50%,-50%) scale(.6);opacity:0}20%{transform:translate(-50%,-140%) scale(1.1);opacity:1}100%{transform:translate(-50%,-280%) scale(1);opacity:0}}
    .float{position:absolute;pointer-events:none;animation:jump 1.15s ease-out forwards;font-weight:900;text-shadow:0 4px 8px rgba(0,0,0,.9);z-index:100;white-space:nowrap}
    @keyframes fly{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--tx),var(--ty)) scale(.5);opacity:0}}
    .fly{position:absolute;pointer-events:none;z-index:100;animation:fly .75s cubic-bezier(.5,0,.5,1) forwards}
    @keyframes pulse{0%{border-color:rgba(234,179,8,1);box-shadow:0 0 0 0 rgba(234,179,8,.7)}50%{border-color:#facc15;box-shadow:0 0 18px 10px rgba(234,179,8,.55)}100%{border-color:rgba(234,179,8,1);box-shadow:0 0 0 0 rgba(234,179,8,0)}}
    @keyframes bounce{0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(10px)}}
    @keyframes guidanceGlow{0%,100%{box-shadow:0 -4px 20px rgba(250,204,21,0.5),0 0 0 rgba(250,204,21,0)}50%{box-shadow:0 -4px 30px rgba(250,204,21,0.8),0 0 20px rgba(250,204,21,0.4)}}
    @keyframes guidanceSlide{0%{transform:translateY(100%)}100%{transform:translateY(0)}}
    .hl{animation:pulse 1s infinite !important;border:2px solid #eab308 !important;background:rgba(234,179,8,.06)!important;position:relative;z-index:50}
    .arrow{position:absolute;top:-30px;left:50%;transform:translateX(-50%);font-size:26px;animation:bounce 1s infinite;z-index:100;filter:drop-shadow(0 2px 4px rgba(0,0,0,1));pointer-events:none}
    .guidance-bar{animation:guidanceSlide 0.3s ease-out,guidanceGlow 2s ease-in-out infinite}
    @keyframes ticker{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
    ::-webkit-scrollbar{width:4px;height:4px}
    ::-webkit-scrollbar-track{background:#0f172a}
    ::-webkit-scrollbar-thumb{background:#334155;border-radius:2px}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback } = React;

    // ---- tiny tests (keep) ----
    const clampDt = (dt) => Math.min(0.10, Math.max(0.02, dt));
    console.assert(clampDt(0.001) === 0.02, 'clampDt min failed');
    console.assert(clampDt(0.5) === 0.10, 'clampDt max failed');

    // ---- Error Boundary ----
    class ErrorBoundary extends React.Component {
      constructor(p){ super(p); this.state={hasError:false,error:null}; }
      static getDerivedStateFromError(e){ return {hasError:true,error:e}; }
      componentDidCatch(e,info){ console.error('Game crashed:',e,info); }
      render(){
        if(this.state.hasError){
          return (
            <div className="h-screen w-full bg-red-900 text-white p-6 flex flex-col items-center justify-center overflow-auto">
              <h1 className="text-2xl font-bold mb-3">âš ï¸ SYSTEM FAILURE</h1>
              <div className="text-xs mb-4 max-w-lg overflow-auto max-h-48 whitespace-pre-wrap">{String(this.state.error)}</div>
              <button onClick={() => window.location.reload()} className="mt-4 bg-white text-red-900 font-bold py-2 px-6 rounded">RELOAD</button>
            </div>
          );
        }
        return this.props.children;
      }
    }

    // ---- helpers ----
    const SUFFIXES = ["","k","M","B","T","Qa","Qi","Sx","Sp","Oc","No","Dc"];
    const fmt = (n) => {
      if(n==null) return '0';
      if(typeof n!=='number') return 'NaN';
      if(!Number.isFinite(n)) return 'MAX';
      if(n<1000) return (Math.floor(n*100)/100).toString();
      const tier = (Math.log10(Math.abs(n))/3)|0;
      if(tier<=0) return String(Math.floor(n));
      const s = SUFFIXES[Math.min(tier, SUFFIXES.length-1)];
      const scale = Math.pow(10, tier*3);
      return (n/scale).toFixed(2)+s;
    };

    // DPR-safe canvas fit
    const fitCanvasToParent = (canvas) => {
      const parent = canvas?.parentElement;
      if(!canvas || !parent) return;
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const cssW = Math.max(1, parent.clientWidth);
      const cssH = Math.max(1, parent.clientHeight);
      canvas.style.width = cssW+'px';
      canvas.style.height = cssH+'px';
      canvas.width = Math.floor(cssW*dpr);
      canvas.height = Math.floor(cssH*dpr);
      const ctx = canvas.getContext('2d');
      if(ctx) ctx.setTransform(dpr,0,0,dpr,0,0);
    };

    // Game calculation helpers
    const calcCost = (baseCost, costFactor, level) => baseCost * Math.pow(costFactor || 1, level);
    const calcValue = (baseValue, level, multiplier = 1.1) => baseValue * Math.pow(multiplier, level);
    
    // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å¾Œã®æŒ‡æ•°é–¢æ•°çš„æˆé•·è¨ˆç®—ï¼ˆãƒªãƒãƒ¼ã‚¹å›æ•°ã®ã¿ã«å¿œã˜ã¦ï¼‰
    const calcExponentialGrowth = (base, discoveredFactors, region, isTutorialComplete) => {
      if(!isTutorialComplete && region === 0) return 1.0; // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ä¸­ã¯æˆé•·ãªã—
      // ãƒ™ãƒ¼ã‚¹ã§100å€ã€ãƒªãƒãƒ¼ã‚¹å›æ•°ã«å¿œã˜ãŸè¿½åŠ æˆé•·ï¼ˆ1.5^ãƒªãƒãƒ¼ã‚¹å›æ•°ï¼‰
      // ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ç™ºè¦‹æ•°ã¯ä½¿ã‚ãªã„ï¼ˆãƒ•ã‚¡ãƒ³ãƒ‰ã®ã‚³ã‚¹ãƒˆãŒãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ç™ºè¦‹ã§ä¸ŠãŒã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
      const baseMultiplier = 100;
      const regionBonus = region > 0 ? Math.pow(1.5, region) : 1.0;
      return baseMultiplier * regionBonus;
    };

    // ---- Game content ----
    const FACTORS = [
      { id:'beta', name:'Market Beta', threshold: 20, color:'#3b82f6', waveFreq:0.02, waveAmp:30 },
      { id:'size', name:'Size', threshold: 80, color:'#4ade80', waveFreq:0.05, waveAmp:20 },
      { id:'value', name:'Value', threshold: 200, color:'#fbbf24', waveFreq:0.08, waveAmp:15 },
      { id:'momentum', name:'Momentum', threshold: 500, color:'#ef4444', waveFreq:0.10, waveAmp:18 },
      { id:'quality', name:'Quality', threshold: 1200, color:'#8b5cf6', waveFreq:0.12, waveAmp:16 },
      { id:'lowvol', name:'Low Volatility', threshold: 3000, color:'#06b6d4', waveFreq:0.14, waveAmp:14 },
      { id:'dividend', name:'Dividend Yield', threshold: 8000, color:'#10b981', waveFreq:0.16, waveAmp:12 },
      { id:'profitability', name:'Profitability', threshold: 20000, color:'#f59e0b', waveFreq:0.18, waveAmp:10 },
      { id:'earnings', name:'Earnings Yield', threshold: 50000, color:'#6366f1', waveFreq:0.20, waveAmp:8 },
      { id:'nonlinear', name:'NonLinear', threshold: 120000, color:'#ec4899', waveFreq:0.22, waveAmp:10 },
      { id:'alphaomega', name:'AlphaOmega (ESG)', threshold: 300000, color:'#ffffff', waveFreq:0.25, waveAmp:40 },
    ];

    const UPGRADES = [
      // data (produce DATA/s)
      { id:'intern', category:'data', name:'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³', desc:'ãƒ‡ãƒ¼ã‚¿åé›†ã‚’æ”¯æ´ã€‚', baseCostAum: 25, costFactor:1.45, effectVal:1, icon:'ğŸ“' },
      { id:'scraper', category:'data', name:'Webã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼', desc:'ãƒãƒƒãƒˆã‹ã‚‰è‡ªå‹•åé›†ã€‚', baseCostAum: 300, costFactor:1.55, effectVal:10, icon:'ğŸ•·ï¸' },
      { id:'data_warehouse', category:'data', name:'ãƒ‡ãƒ¼ã‚¿ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹', desc:'å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã€‚', baseCostAum: 3000, costFactor:1.6, effectVal:100, icon:'ğŸ¢' },
      { id:'satellite', category:'data', name:'è¡›æ˜Ÿãƒ•ã‚£ãƒ¼ãƒ‰', desc:'è¡›æ˜Ÿãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾—ã€‚', baseCostAum: 30000, costFactor:1.65, effectVal:1000, icon:'ğŸ›°ï¸' },
      { id:'quantum_db', category:'data', name:'é‡å­ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹', desc:'é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã§ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã€‚', baseCostAum: 300000, costFactor:1.7, effectVal:10000, icon:'âš›ï¸' },
      { id:'akashic', category:'data', name:'ã‚¢ã‚«ã‚·ãƒƒã‚¯ãƒ¬ã‚³ãƒ¼ãƒ‰', desc:'ã‚¢ã‚«ã‚·ãƒƒã‚¯ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã€‚', baseCostAum: 3000000, costFactor:1.75, effectVal:100000, icon:'ğŸ“œ' },

      // research (consume DATA -> produce RESEARCH/s)
      { id:'analyst', category:'research', name:'ã‚¢ãƒŠãƒªã‚¹ãƒˆ', desc:'DATAã‚’åˆ†æã—ã¦RESEARCHã¸ã€‚', baseCostAum: 60, costFactor:1.55, inputNoise:2, outputResearch:1, icon:'ğŸ“Š' },
      { id:'ml_cluster', category:'research', name:'MLã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼', desc:'é«˜é€Ÿåˆ†æåŸºç›¤ã€‚', baseCostAum: 1200, costFactor:1.65, inputNoise:18, outputResearch:12, icon:'ğŸ–¥ï¸' },
      { id:'quantum_lab', category:'research', name:'é‡å­ãƒ©ãƒœ', desc:'é‡å­ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§è§£æã€‚', baseCostAum: 15000, costFactor:1.7, inputNoise:200, outputResearch:150, icon:'ğŸ”¬' },
      { id:'ai_supermind', category:'research', name:'AIã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒã‚¤ãƒ³ãƒ‰', desc:'è¶…çŸ¥èƒ½AIã«ã‚ˆã‚‹åˆ†æã€‚', baseCostAum: 200000, costFactor:1.75, inputNoise:2000, outputResearch:2000, icon:'ğŸ¤–' },
      { id:'dimensional_rift', category:'research', name:'æ¬¡å…ƒãƒªãƒ•ãƒˆ', desc:'æ¬¡å…ƒã‚’è¶…ãˆãŸç ”ç©¶ã€‚', baseCostAum: 2500000, costFactor:1.8, inputNoise:20000, outputResearch:25000, icon:'ğŸŒ€' },

      // strategy (creates opportunities) - å„æˆ¦ç•¥ã¯ç™ºè¦‹ã—ãŸãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã«é–¢é€£ã™ã‚‹
      { id:'index_fund', category:'strategy', name:'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ãƒ³ãƒ‰', reqFactor:'beta', desc:'å¸‚å ´ã®å‹•ãã«é€£å‹•ã€‚', baseCostAum: 200, baseCostResearch: 3, costFactor:1.6, passiveYield:0.004, baseValue: 5000, frequency:0.06, icon:'ğŸ“ˆ' },
      { id:'small_cap_fund', category:'strategy', name:'ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚­ãƒ£ãƒƒãƒ—ãƒ•ã‚¡ãƒ³ãƒ‰', reqFactor:'size', desc:'å°å‹æ ªåŠ¹æœã‚’ç‹™ã†ã€‚', baseCostAum: 1200, baseCostResearch: 25, costFactor:1.7, passiveYield:0.007, baseValue: 18000, frequency:0.07, icon:'ğŸœ' },
      { id:'value_fund', category:'strategy', name:'ãƒãƒªãƒ¥ãƒ¼ãƒ•ã‚¡ãƒ³ãƒ‰', reqFactor:'value', desc:'å‰²å®‰æ ªã‚’æ‹¾ã†ã€‚', baseCostAum: 8000, baseCostResearch: 120, costFactor:1.75, passiveYield:0.010, baseValue: 65000, frequency:0.08, icon:'ğŸ’' },
      { id:'momentum_fund', category:'strategy', name:'ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ ãƒ•ã‚¡ãƒ³ãƒ‰', reqFactor:'momentum', desc:'å‹¢ã„ã®ã‚ã‚‹éŠ˜æŸ„ã‚’è¿½ã†ã€‚', baseCostAum: 50000, baseCostResearch: 600, costFactor:1.8, passiveYield:0.015, baseValue: 250000, frequency:0.09, icon:'ğŸš€' },
      { id:'quality_fund', category:'strategy', name:'ã‚¯ã‚ªãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ³ãƒ‰', reqFactor:'quality', desc:'é«˜å“è³ªãªä¼æ¥­ã‚’é¸åˆ¥ã€‚', baseCostAum: 400000, baseCostResearch: 5000, costFactor:1.85, passiveYield:0.020, baseValue: 1500000, frequency:0.10, icon:'â­' },
      { id:'lowvol_fund', category:'strategy', name:'ä½ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ³ãƒ‰', reqFactor:'lowvol', desc:'ä½ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£éŠ˜æŸ„ã‚’é¸åˆ¥ã€‚', baseCostAum: 5000000, baseCostResearch: 60000, costFactor:1.9, passiveYield:0.030, baseValue: 20000000, frequency:0.12, icon:'ğŸŒŠ' },
      { id:'dividend_fund', category:'strategy', name:'é…å½“åˆ©å›ã‚Šãƒ•ã‚¡ãƒ³ãƒ‰', reqFactor:'dividend', desc:'é«˜é…å½“éŠ˜æŸ„ã«æŠ•è³‡ã€‚', baseCostAum: 50000000, baseCostResearch: 600000, costFactor:1.95, passiveYield:0.040, baseValue: 150000000, frequency:0.14, icon:'ğŸ’°' },
      { id:'profitability_fund', category:'strategy', name:'åç›Šæ€§ãƒ•ã‚¡ãƒ³ãƒ‰', reqFactor:'profitability', desc:'é«˜åç›Šä¼æ¥­ã‚’é¸åˆ¥ã€‚', baseCostAum: 500000000, baseCostResearch: 6000000, costFactor:2.0, passiveYield:0.050, baseValue: 1000000000, frequency:0.16, icon:'ğŸ“Š' },
      { id:'earnings_fund', category:'strategy', name:'åç›Šç‡ãƒ•ã‚¡ãƒ³ãƒ‰', reqFactor:'earnings', desc:'é«˜åç›Šç‡éŠ˜æŸ„ã«æŠ•è³‡ã€‚', baseCostAum: 5000000000, baseCostResearch: 60000000, costFactor:2.05, passiveYield:0.060, baseValue: 8000000000, frequency:0.18, icon:'ğŸ’¹' },
      { id:'hedge_fund', category:'strategy', name:'ãƒ˜ãƒƒã‚¸ãƒ•ã‚¡ãƒ³ãƒ‰', reqFactor:'nonlinear', desc:'éç·šå½¢æˆ¦ç•¥ã§åˆ©ç›Šã‚’è¿½æ±‚ã€‚', baseCostAum: 50000000000, baseCostResearch: 600000000, costFactor:2.1, passiveYield:0.070, baseValue: 60000000000, frequency:0.20, icon:'ğŸ¯' },
      { id:'alphaomega_fund', category:'strategy', name:'AlphaOmega (ESG) ãƒ•ã‚¡ãƒ³ãƒ‰', reqFactor:'alphaomega', desc:'ESGã‚’çµ±åˆã—ãŸç©¶æ¥µã®æˆ¦ç•¥ã€‚', baseCostAum: 500000000000, baseCostResearch: 6000000000, costFactor:2.15, passiveYield:0.100, baseValue: 500000000000, frequency:0.25, icon:'ğŸŒ' },
      
      // è‡ªå‹•ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆãƒªãƒãƒ¼ã‚¹å›æ•°ã«å¿œã˜ã¦è³¼å…¥å¯èƒ½ï¼‰
      { id:'auto_upgrade_data', category:'data', name:'ãƒ‡ãƒ¼ã‚¿åé›†æœ€é©åŒ–', desc:'ãƒ‡ãƒ¼ã‚¿åé›†è³¼å…¥ãŒè‡ªå‹•åŒ–ã•ã‚Œã¾ã™ã€‚', baseCostAum: 1000000000, costFactor:1.5, effectVal:0, autoUpgrade:true, reqRegion:2, icon:'ğŸ¤–' },
      { id:'auto_upgrade_research', category:'research', name:'ãƒªã‚µãƒ¼ãƒæœ€é©åŒ–', desc:'ãƒªã‚µãƒ¼ãƒã®è³¼å…¥ãŒè‡ªå‹•åŒ–ã•ã‚Œã¾ã™ã€‚', baseCostAum: 5000000000, costFactor:1.5, inputNoise:0, outputResearch:0, autoUpgrade:true, reqRegion:3, icon:'ğŸ§ ' },
      { id:'auto_upgrade_strategy', category:'strategy', name:'æˆ¦ç•¥æœ€é©åŒ–', desc:'æˆ¦ç•¥ã®è³¼å…¥ãŒè‡ªå‹•åŒ–ã•ã‚Œã¾ã™ã€‚', baseCostAum: 50000000000, costFactor:1.5, passiveYield:0, baseValue:0, frequency:0, autoUpgrade:true, reqRegion:4, icon:'âš¡' },
    ];

    const NEWS = [
      'Market Update: factor crowding detected.',
      'Breaking: â€œAI says buyâ€ trend spikes.',
      'Quant gossip: volatility smiles back.',
      'Macro: rates do a barrel roll.',
    ];

    const calcRates = (s) => {
      const lvl = (id) => s.levels[id] || 0;
      
      // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†åˆ¤å®šï¼ˆregion === 0 ã‹ã¤ index_fund ãŒè³¼å…¥ã•ã‚Œã¦ã„ã‚‹ï¼‰
      const isTutorialComplete = s.region === 0 && lvl('index_fund') > 0;
      // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ä»¥å¤–ã®å³ã—ã„æˆé•·ç‡ï¼ˆ50%å‰Šæ¸›ï¼‰
      const growthPenalty = (isTutorialComplete || s.region > 0) ? 0.5 : 1.0;
      
      // è‡ªå‹•ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®åŠ¹æœ
      const hasAutoData = lvl('auto_upgrade_data') > 0;
      const hasAutoResearch = lvl('auto_upgrade_research') > 0;
      const hasAutoStrategy = lvl('auto_upgrade_strategy') > 0;

      // DATA production (è‡ªå‹•ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ™‚ã¯ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿åé›†ã‚’è‡ªå‹•åŒ–)
      let dataProd = 0;
      if(hasAutoData){
        // è‡ªå‹•ãƒ‡ãƒ¼ã‚¿åé›†: ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿åé›†ã‚«ãƒ¼ãƒ‰ã®åŠ¹æœã‚’è‡ªå‹•ã§é©ç”¨
        for(const u of UPGRADES){ 
          if(u.category==='data' && !u.autoUpgrade) {
            dataProd += (u.effectVal||0) * Math.max(1, lvl(u.id)); // ãƒ¬ãƒ™ãƒ«0ã§ã‚‚1ã¨ã—ã¦æ‰±ã†
          }
        }
      } else {
        for(const u of UPGRADES){ if(u.category==='data' && !u.autoUpgrade) dataProd += (u.effectVal||0) * lvl(u.id); }
      }
      dataProd *= growthPenalty; // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å¾Œã®æˆé•·ç‡å‰Šæ¸›

      // RESEARCH production (è‡ªå‹•ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ™‚ã¯ã™ã¹ã¦ã®ãƒªã‚µãƒ¼ãƒã‚’è‡ªå‹•åŒ–)
      let dataCons = 0, resProd = 0;
      if(hasAutoResearch){
        // è‡ªå‹•ãƒªã‚µãƒ¼ãƒ: ã™ã¹ã¦ã®ãƒªã‚µãƒ¼ãƒã‚«ãƒ¼ãƒ‰ã®åŠ¹æœã‚’è‡ªå‹•ã§é©ç”¨
        for(const u of UPGRADES){
          if(u.category==='research' && !u.autoUpgrade){
            const effectiveLvl = Math.max(1, lvl(u.id));
            dataCons += (u.inputNoise||0) * effectiveLvl;
            resProd += (u.outputResearch||0) * effectiveLvl;
          }
        }
      } else {
        for(const u of UPGRADES){
          if(u.category==='research' && !u.autoUpgrade){
            dataCons += (u.inputNoise||0) * lvl(u.id);
            resProd += (u.outputResearch||0) * lvl(u.id);
          }
        }
      }
      resProd *= growthPenalty; // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å¾Œã®æˆé•·ç‡å‰Šæ¸›

      // passive yield from strategies (è‡ªå‹•æˆ¦ç•¥æœ€é©åŒ–æ™‚ã¯ã™ã¹ã¦ã®æˆ¦ç•¥ã‚’è‡ªå‹•ã§æœ€é©åŒ–)
      let passive = 0.001;
      if(hasAutoStrategy){
        // è‡ªå‹•æˆ¦ç•¥æœ€é©åŒ–: ã™ã¹ã¦ã®æˆ¦ç•¥ã®åŠ¹æœã‚’è‡ªå‹•ã§é©ç”¨
        for(const u of UPGRADES){ 
          if(u.category==='strategy' && !u.autoUpgrade) {
            passive += (u.passiveYield||0) * Math.max(1, lvl(u.id));
          }
        }
      } else {
        for(const u of UPGRADES){ if(u.category==='strategy' && !u.autoUpgrade) passive += (u.passiveYield||0) * lvl(u.id); }
      }
      passive *= growthPenalty; // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å¾Œã®æˆé•·ç‡å‰Šæ¸›

      const netData = dataProd - dataCons;

      // taps (base value + bonus from production)
      const clickData = 10 + dataProd * 0.2;
      const clickRes = 5 + resProd * 0.15;
      const clickResCost = Math.max(10, clickRes * 2);

      return {
        dataProd, dataCons, resProd, netData,
        passive,
        clickData, clickRes, clickResCost,
      };
    };

    // ---- UI bits ----
    const Modal = ({ title, body, buttonText, onConfirm, icon }) => (
      <div className="absolute inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 backdrop-blur">
        <div className="bg-gray-900 border-2 border-blue-500/50 p-6 rounded-xl max-w-lg w-full flex flex-col items-center text-center shadow-2xl">
          <div className="text-6xl mb-4">{icon||'âœ¨'}</div>
          <h3 className="text-2xl font-bold mb-4 text-white">{title}</h3>
          <div className="text-gray-300 mb-6 leading-relaxed whitespace-pre-line text-base">{body}</div>
          <button onClick={onConfirm} className="font-bold py-3 px-8 rounded-full w-full bg-blue-600 text-white">{buttonText||'OK'}</button>
        </div>
      </div>
    );

    const ResourceItem = ({ label, value, subValue, subColor, highlight }) => (
      <div className={`flex flex-col items-start min-w-[86px] relative ${highlight ? 'hl' : ''}`}>
        <div className="text-[10px] text-gray-500 font-mono tracking-widest">{label}</div>
        <div className="text-xl font-mono text-white font-bold leading-none">{value}</div>
        {highlight && <div className="arrow">ğŸ‘‡</div>}
        <div className={`text-[10px] font-mono ${subColor}`}>{subValue}</div>
      </div>
    );

    const ActionButton = ({ icon, label, sub, onClick, disabled, highlight, active, tone='dark' }) => (
      <button
        onClick={onClick}
        disabled={disabled}
        className={`relative flex-1 min-h-[60px] rounded-xl border px-2 py-2 flex flex-col items-center justify-center gap-0.5 transition-all active:scale-[0.99] select-none ${
          active ? 'bg-yellow-800/35 border-yellow-500' : tone==='blue' ? 'bg-blue-900/30 border-blue-500/40' : 'bg-gray-900/40 border-gray-700'
        } ${disabled ? 'opacity-45' : ''} ${highlight ? 'hl' : ''}`}
      >
        <div className="text-2xl leading-none">{icon}</div>
        <div className="text-[11px] font-mono font-black tracking-wide text-gray-100">{label}</div>
        {sub && <div className="text-[10px] font-mono text-gray-300">{sub}</div>}
        {highlight && <div className="arrow">ğŸ‘‡</div>}
      </button>
    );

    const Flying = ({ startX, startY, targetX, targetY }) => (
      <div className="fly" style={{ left:startX, top:startY, '--tx': `${targetX-startX}px`, '--ty': `${targetY-startY}px`, fontSize:'24px' }}>ğŸ’°</div>
    );

    // ---- Canvases ----
    const WaveCanvas = ({ unlockedFactors }) => {
      const canvasRef = useRef(null);
      const factorsRef = useRef(unlockedFactors);
      useEffect(() => { factorsRef.current = unlockedFactors; }, [unlockedFactors]);

      useEffect(() => {
        const canvas = canvasRef.current;
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        if(!ctx) return;

        let raf = 0;
        let t = 0;
        const resize = () => fitCanvasToParent(canvas);

        const draw = () => {
          const w = canvas.clientWidth;
          const h = canvas.clientHeight;
          if(w<=0||h<=0){ raf=requestAnimationFrame(draw); return; }

          t += 0.05;

          // solid bg
          ctx.clearRect(0,0,w,h);
          ctx.fillStyle = '#000';
          ctx.fillRect(0,0,w,h);

          // grid
          ctx.strokeStyle = 'rgba(255,255,255,0.06)';
          ctx.lineWidth = 1;
          ctx.beginPath();
          for(let x=0;x<w;x+=40){ ctx.moveTo(x,0); ctx.lineTo(x,h); }
          for(let y=0;y<h;y+=30){ ctx.moveTo(0,y); ctx.lineTo(w,y); }
          ctx.stroke();

          const centerY = h/2;
          const unlocked = factorsRef.current || [];

          // noise
          ctx.beginPath();
          ctx.strokeStyle = 'rgba(255,255,255,0.22)';
          ctx.lineWidth = 1;
          for(let x=0;x<w;x++){
            let y = (Math.random()-0.5)*16;
            for(const f of unlocked){ y += Math.sin(x*f.waveFreq + t*(f.waveFreq*10))* (f.waveAmp*0.25); }
            if(x===0) ctx.moveTo(x, centerY+y); else ctx.lineTo(x, centerY+y);
          }
          ctx.stroke();

          // factor waves
          for(let i=0;i<unlocked.length;i++){
            const f = unlocked[i];
            ctx.beginPath();
            ctx.strokeStyle = f.color;
            ctx.lineWidth = 2;
            for(let x=0;x<w;x++){
              const y = Math.sin(x*f.waveFreq + t*(f.waveFreq*15) + i) * f.waveAmp;
              if(x===0) ctx.moveTo(x, centerY+y); else ctx.lineTo(x, centerY+y);
            }
            ctx.stroke();
          }

          raf = requestAnimationFrame(draw);
        };

        window.addEventListener('resize', resize);
        resize();
        draw();
        return () => { window.removeEventListener('resize', resize); cancelAnimationFrame(raf); };
      }, []);

      return <canvas ref={canvasRef} className="absolute inset-0" />;
    };

    const OpportunityCanvas = ({ opportunities }) => {
      const canvasRef = useRef(null);
      const oppRef = useRef(opportunities);
      useEffect(() => { oppRef.current = opportunities; }, [opportunities]);

      useEffect(() => {
        const canvas = canvasRef.current;
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        if(!ctx) return;

        let raf = 0;
        const resize = () => fitCanvasToParent(canvas);

        const draw = () => {
          const w = canvas.clientWidth;
          const h = canvas.clientHeight;
          if(w<=0||h<=0){ raf=requestAnimationFrame(draw); return; }

          ctx.clearRect(0,0,w,h);
          const centerY = h/2;
          const ops = oppRef.current || [];

          for(const op of ops){
            const size = 8 + (Math.log10(Math.max(1, op.val||1))*0.8);
            const s = op.status==='exploding' ? size*op.scale : size;
            const a = op.status==='exploding' ? Math.max(0, 1 - (op.scale-1)/1.5) : 1;
            ctx.globalAlpha = a;
            ctx.shadowBlur = 10;
            ctx.shadowColor = op.color;
            ctx.fillStyle = op.color;
            ctx.beginPath();
            ctx.arc(op.x, centerY, s, 0, Math.PI*2);
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.fillStyle = `rgba(255,255,255,${a})`;
            ctx.font = `${Math.floor(12*(op.status==='exploding'?op.scale:1))}px monospace`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('ğŸ’°', op.x, centerY);
            ctx.globalAlpha = 1;
          }

          // center line
          ctx.strokeStyle = 'rgba(255,255,255,0.35)';
          ctx.lineWidth = 2;
          ctx.setLineDash([5,5]);
          ctx.beginPath();
          ctx.moveTo(w/2, 0);
          ctx.lineTo(w/2, h);
          ctx.stroke();
          ctx.setLineDash([]);

          raf = requestAnimationFrame(draw);
        };

        window.addEventListener('resize', resize);
        resize();
        draw();
        return () => { window.removeEventListener('resize', resize); cancelAnimationFrame(raf); };
      }, []);

      return <canvas ref={canvasRef} className="absolute inset-0 pointer-events-none" />;
    };

    function App(){
      const [state, setState] = useState({
        phase: 'start',
        noise: 30,       // DATAï¼ˆåˆæœŸå€¤: æ‰‹å‹•åé›†ãªã—ã§é–‹å§‹ï¼‰
        research: 0,    // RESEARCH
        aum: 1000,      // $AUM
        levels: {},
        unlockedTabs: ['data', 'research'], // researchã‚¿ãƒ–ã‚’åˆæœŸã‹ã‚‰ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
        discoveredFactorIds: [],
        fundraiseCount: 0,
        region: 0,      // ç¾åœ¨ã®åœ°åŸŸï¼ˆ0=åˆæœŸåœ°åŸŸï¼‰
      });

      const [activeTab, setActiveTab] = useState('data');
      const [modal, setModal] = useState(null);
      const [ticker, setTicker] = useState(NEWS[0]);
      const [opps, setOpps] = useState([]);
      const [floats, setFloats] = useState([]);
      const [flys, setFlys] = useState([]);
      const [guidanceSkipped, setGuidanceSkipped] = useState(new Set());
      const [marketEvent, setMarketEvent] = useState(null); // {type: 'crash'|'fever', duration: number, startTime: number}
      const [currentTime, setCurrentTime] = useState(Date.now()); // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³æ›´æ–°ç”¨
      const [lastEventEndTime, setLastEventEndTime] = useState(null); // æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆçµ‚äº†æ™‚åˆ»
      const [momentumFactorDiscoveredTime, setMomentumFactorDiscoveredTime] = useState(null); // Momentumãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ç™ºè¦‹æ™‚åˆ»
      const [marketEventGuidanceActive, setMarketEventGuidanceActive] = useState(false); // ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚¬ã‚¤ãƒ€ãƒ³ã‚¹è¡¨ç¤ºä¸­ã‹
      const [marketEventGuidanceDone, setMarketEventGuidanceDone] = useState(false); // ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’å®Œäº†ã—ãŸã‹
      const lastAutoBuyRef = useRef({ data: 0, research: 0, strategy: 0 }); // æœ€å¾Œã«è‡ªå‹•è³¼å…¥ã—ãŸæ™‚åˆ»

      const stateRef = useRef(state);
      const lastLoopRef = useRef(Date.now());
      const nextEventTimeRef = useRef(null); // æ¬¡å›ã®ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚åˆ»
      useEffect(() => { stateRef.current = state; }, [state]);

      const rates = useMemo(() => calcRates(state), [state]);
      
      // ãƒªãƒãƒ¼ã‚¹å¾Œã€ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆã®é–¾å€¤ã‚’èª¿æ•´ï¼ˆãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å¾Œã®æŒ‡æ•°é–¢æ•°çš„æˆé•·ã¨ãƒªãƒãƒ¼ã‚¹å¾Œã®ãƒãƒ©ãƒ³ã‚¹ï¼‰
      const getFactorThreshold = useCallback((baseThreshold) => {
        const isTutorialComplete = state.region === 0 && (state.levels.index_fund || 0) > 0;
        
        if(state.region === 0) {
          // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å¾Œã¯æŒ‡æ•°é–¢æ•°çš„æˆé•·ã‚’é©ç”¨
          if(isTutorialComplete) {
            const growth = calcExponentialGrowth(1, state.discoveredFactorIds.length, 0, true);
            return baseThreshold * growth;
          }
          return baseThreshold;
        }
        
        // ãƒªãƒãƒ¼ã‚¹å¾Œï¼šå°‘ã—ãƒãƒ¼ãƒ‰ãƒ«ã‚’ä¸Šã’ã‚‹ï¼ˆ1.2å€ï¼‰ã€ã§ã‚‚ãƒªãƒãƒ¼ã‚¹åŠ¹æœã¯ç¶­æŒ
        // ãƒªãƒãƒ¼ã‚¹å›æ•°ã«å¿œã˜ã¦å°‘ã—å¢—ã‚„ã™ï¼ˆãƒªãƒãƒ¼ã‚¹1å›ç›®: 1.2å€ã€2å›ç›®: 1.3å€...ï¼‰
        const baseIncrease = 1.0 + (state.region * 0.1); // ãƒªãƒãƒ¼ã‚¹å›æ•°ã”ã¨ã«10%å¢—
        return baseThreshold * baseIncrease;
      }, [state.region, state.discoveredFactorIds, state.levels]);
      
      const nextFactor = useMemo(() => {
        const factor = FACTORS.find(f => !state.discoveredFactorIds.includes(f.id));
        if(!factor) return null;
        return {
          ...factor,
          threshold: getFactorThreshold(factor.threshold)
        };
      }, [state.discoveredFactorIds, getFactorThreshold]);
      
      const unlockedFactors = useMemo(() => FACTORS.filter(f => state.discoveredFactorIds.includes(f.id)), [state.discoveredFactorIds]);

      const spawnFloat = useCallback((text, color, x, y) => {
        const id = Date.now()+Math.random();
        setFloats(p => [...p, {id, text, color, x, y, fontSize: `${Math.floor(12*(0.9+Math.random()*0.4))}px`}]);
        setTimeout(() => setFloats(p => p.filter(i => i.id!==id)), 1200);
      }, []);

      const spawnFly = useCallback((startX, startY) => {
        const el = document.getElementById('aum-anchor');
        if(!el) return;
        const r = el.getBoundingClientRect();
        const targetX = r.left + r.width/2;
        const targetY = r.top + r.height/2;
        // ã‚ˆã‚Šä¸€æ„ãªIDã‚’ç”Ÿæˆï¼ˆã‚­ãƒ¼ã®é‡è¤‡ã‚’é˜²ãï¼‰
        const id = `${Date.now()}-${Math.random()}-${Math.random()}`;
        setFlys(p => [...p, {id, startX, startY, targetX, targetY}]);
        setTimeout(() => setFlys(p => p.filter(i => i.id!==id)), 800);
      }, []);

      // modal start
      useEffect(() => {
        if(state.phase==='start'){
          setModal({
            title: 'âš¡ é‹ç”¨ä¼šç¤¾ã‚’ç«‹ã¡ä¸Šã’ã‚ˆã† âš¡',
            body: `å¸‚å ´ã®ç§˜å¯†ã‚’è§£ãæ˜ã‹ã—ã€ä¸–ç•Œä¸€ã®é‹ç”¨ä¼šç¤¾ã‚’ä½œã‚Šä¸Šã’ã‚ï¼`,
            buttonText: 'ğŸš€ ã‚¹ã‚¿ãƒ¼ãƒˆ',
            icon: 'ğŸ“ˆ',
            onConfirm: () => setState(p => ({...p, phase:'running'}))
          });
        }
      }, [state.phase]);

      // ticker
      useEffect(() => {
        const t = setInterval(() => setTicker(NEWS[(Math.random()*NEWS.length)|0]), 8000);
        return () => clearInterval(t);
      }, []);
      
      // currentTimeæ›´æ–°ï¼ˆMomentumãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ç™ºè¦‹å¾Œã¯å¸¸ã«æ›´æ–°ï¼šã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºï¼‰
      useEffect(() => {
        const hasMomentum = state.discoveredFactorIds.includes('momentum');
        if(!hasMomentum) return;
        
        // å³åº§ã«æ›´æ–°ã‚’é–‹å§‹
        const tick = () => setCurrentTime(Date.now());
        tick(); 
        
        const interval = setInterval(tick, 100); 
        return () => clearInterval(interval);
      }, [state.discoveredFactorIds]);

      // unlock tabs
      const discoveredFactorIdsStr = state.discoveredFactorIds.join(',');
      const unlockedTabsStr = state.unlockedTabs.join(',');
      useEffect(() => {
        // strategyã‚¿ãƒ–ã¯ãƒ™ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ç™ºè¦‹æ™‚ã«ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
        if(state.discoveredFactorIds.includes('beta') && !state.unlockedTabs.includes('strategy')){
          setState(p => p.unlockedTabs.includes('strategy') ? p : ({...p, unlockedTabs:[...p.unlockedTabs,'strategy']}));
        }
      }, [discoveredFactorIdsStr, unlockedTabsStr]);

      // factor discovery celebration
      const prevFactorIdsRef = useRef([]);
      useEffect(() => {
        if(state.phase === 'running' && state.discoveredFactorIds.length > prevFactorIdsRef.current.length){
          const newFactorId = state.discoveredFactorIds.find(id => !prevFactorIdsRef.current.includes(id));
          if(newFactorId){
            const newFactor = FACTORS.find(f => f.id === newFactorId);
            if(newFactor){
              const isAlphaOmega = newFactorId === 'alphaomega';
              // å¯¾å¿œã™ã‚‹æˆ¦ç•¥ã‚’æ¤œç´¢
              const correspondingStrategy = UPGRADES.find(u => u.reqFactor === newFactorId && u.category === 'strategy');
              const strategyName = correspondingStrategy ? correspondingStrategy.name : '';
              
              setModal({
                title: 'âœ¨ ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ç™ºè¦‹ï¼ âœ¨',
                body: isAlphaOmega ? `${newFactor.name}ã‚’ç™ºè¦‹ã—ã¾ã—ãŸï¼

ã™ã¹ã¦ã®æŠ•è³‡æˆ¦ç•¥ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸã€‚
æ–°ã—ã„æƒ‘æ˜Ÿã¸ã®æŠ•è³‡ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸï¼` : strategyName ? `${newFactor.name}ã‚’ç™ºè¦‹ã—ã¾ã—ãŸï¼

ã€Œ${strategyName}ã€ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸï¼` : `${newFactor.name}ã‚’ç™ºè¦‹ã—ã¾ã—ãŸï¼

æ–°ã—ã„æŠ•è³‡æˆ¦ç•¥ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸã€‚`,
                buttonText: 'ğŸš€ ç¶šã‘ã‚‹',
                icon: 'ğŸŒŸ',
                onConfirm: () => setModal(null)
              });
              // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ†ã‚­ã‚¹ãƒˆã‚’è¤‡æ•°è¡¨ç¤º
              setTimeout(() => spawnFloat('ğŸŒŸ', newFactor.color, window.innerWidth/2, window.innerHeight/2), 100);
              setTimeout(() => spawnFloat('FACTOR DISCOVERED!', newFactor.color, window.innerWidth/2, window.innerHeight/2 + 30), 200);
              setTimeout(() => spawnFloat(newFactor.name, newFactor.color, window.innerWidth/2, window.innerHeight/2 + 60), 300);
            }
          }
        }
        prevFactorIdsRef.current = [...state.discoveredFactorIds];
      }, [state.discoveredFactorIds, state.phase, spawnFloat]);

      // Momentumãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ç™ºè¦‹æ™‚åˆ»ã‚’è¨˜éŒ²ï¼ˆåˆå›ã®ã¿ï¼‰
      // currentTimeãŒæ›´æ–°ã•ã‚Œã‚‹ãŸã³ã«å†è©•ä¾¡ã•ã‚Œãªã„ã‚ˆã†ã€ä¾å­˜é…åˆ—ã‚’çµã‚‹
      useEffect(() => {
        if(state.discoveredFactorIds.includes('momentum') && !momentumFactorDiscoveredTime){
          setMomentumFactorDiscoveredTime(Date.now());
        }
      }, [state.discoveredFactorIds]); // momentumFactorDiscoveredTimeã‚’ä¾å­˜ã‹ã‚‰å¤–ã—ã¦ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼ˆã‚»ãƒƒã‚¿ãƒ¼å†…åˆ¤å®šã§ååˆ†ï¼‰

      // guidance
      const guidance = useMemo(() => {
        if(state.region > 0) return null; // ãƒªãƒãƒ¼ã‚¹å¾Œã¯ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ç„¡åŠ¹åŒ–
        
        const noise = state.noise || 0;
        const hasIntern = (state.levels.intern || 0) > 0;
        const hasAnalyst = (state.levels.analyst || 0) > 0;
        const hasBeta = state.discoveredFactorIds.includes('beta');
        const hasIndexFund = (state.levels.index_fund || 0) > 0;
        const hasMomentumFactor = state.discoveredFactorIds.includes('momentum');
        const researchUnlocked = state.unlockedTabs.includes('research');
        const strategyUnlocked = state.unlockedTabs.includes('strategy');
        
        // åˆå›ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚ã®èª¬æ˜ï¼ˆMomentumãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ç™ºè¦‹å¾Œï¼‰
        // å„ªå…ˆåº¦ã‚’é«˜ãè¨­å®šï¼ˆä»–ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ã‚ˆã‚Šå…ˆã«è¡¨ç¤ºï¼‰
        // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¤ãƒ™ãƒ³ãƒˆã®èª¬æ˜ï¼ˆã€Œæ¬¡ã¸ã€ã‚’æŠ¼ã™ã¾ã§è¡¨ç¤ºã—ç¶šã‘ã‚‹ï¼‰
        if(hasMomentumFactor && marketEventGuidanceActive && !guidanceSkipped.has('market-event-intro')){
          return { 
            text:'ğŸ“Š é‹ç”¨è³‡ç”£ãŒæ€¥ã«å¢—æ¸›ã™ã‚‹ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚', 
            highlight:'event-countdown', 
            skipable:true, 
            skipKey:'market-event-intro' 
          };
        }
        // ã‚¹ãƒ†ãƒƒãƒ—2: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®èª¬æ˜ï¼ˆã€Œæ¬¡ã¸ã€ã‚’æŠ¼ã™ã¾ã§è¡¨ç¤ºã—ç¶šã‘ã‚‹ï¼‰
        if(hasMomentumFactor && marketEventGuidanceActive && guidanceSkipped.has('market-event-intro') && !guidanceSkipped.has('market-event-countdown')){
          return { 
            text:'ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’è¦‹ã¦ãã ã•ã„ã€‚ã“ã‚ŒãŒæ¬¡å›ã‚¤ãƒ™ãƒ³ãƒˆã¾ã§ã®æ®‹ã‚Šæ™‚é–“ã§ã™ã€‚', 
            highlight:'event-countdown', 
            skipable:true, 
            skipKey:'market-event-countdown' 
          };
        }
        // ã‚¹ãƒ†ãƒƒãƒ—3: åˆ†æ•£åº¦ã®èª¬æ˜ï¼ˆã€Œæ¬¡ã¸ã€ã‚’æŠ¼ã™ã¾ã§è¡¨ç¤ºã—ç¶šã‘ã‚‹ï¼‰
        if(hasMomentumFactor && marketEventGuidanceActive && guidanceSkipped.has('market-event-countdown') && !guidanceSkipped.has('market-event-diversification')){
          return { 
            text:'åˆ†æ•£åº¦ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚æˆ¦ç•¥ã®æ•°ãŒå¤šã‘ã‚Œã°åˆ†æ•£åº¦ãŒé«˜ãã€ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¤ãƒ™ãƒ³ãƒˆæ™‚ã«ãŠé‡‘ãŒå¢—ãˆã‚„ã™ã„ã§ã™ã€‚', 
            highlight:'diversification-info', 
            skipable:true, 
            skipKey:'market-event-diversification' 
          };
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³è³¼å…¥ã‚’ä¿ƒã™ï¼ˆåˆæœŸçŠ¶æ…‹ï¼‰
        if(!hasIntern) {
          return { text:'ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã¾ã—ã‚‡ã†ã€‚ã€Œè³¼å…¥Ã—1ã€ãƒœã‚¿ãƒ³ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ã‚’æ¡ç”¨', highlight:'buy-intern' };
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—1.5: ãƒ˜ãƒƒãƒ€ãƒ¼ã®èª¬æ˜ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³è³¼å…¥ç›´å¾Œã€ã¾ã ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã„ãªã„å ´åˆï¼‰
        if(hasIntern && !hasAnalyst && !guidanceSkipped.has('auto-data-explanation')) {
          return { text:'ä¸Šã®ã€ŒğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã€ã‚’è¦‹ã¦ãã ã•ã„ã€‚è‡ªå‹•ã§ãƒ‡ãƒ¼ã‚¿ãŒå¢—ãˆã¦ã„ã¾ã™', highlight:'header-data', skipable:true, skipKey:'auto-data-explanation' };
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—2: ãƒªã‚µãƒ¼ãƒã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã‚’ä¿ƒã™ï¼ˆã‚¢ãƒŠãƒªã‚¹ãƒˆæœªè³¼å…¥ã€researchã‚¿ãƒ–ã«ã„ãªã„ï¼‰
        if(!hasAnalyst && researchUnlocked && activeTab !== 'research') {
          return { text:'ãƒªã‚µãƒ¼ãƒã‚¿ãƒ–ã‚’é–‹ãã¾ã—ã‚‡ã†ã€‚ä¸Šã®ã€ŒğŸ”¬ ãƒªã‚µãƒ¼ãƒã€ã‚¿ãƒ–ã‚’ã‚¿ãƒƒãƒ—', highlight:'tab-research' };
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¢ãƒŠãƒªã‚¹ãƒˆè³¼å…¥ã‚’ä¿ƒã™ï¼ˆresearchã‚¿ãƒ–ã«ã„ã‚‹ï¼‰
        if(!hasAnalyst && researchUnlocked && activeTab === 'research') {
          return { text:'ãƒ‡ãƒ¼ã‚¿ã‚’ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆã«å¤‰æ›ã—ã¾ã—ã‚‡ã†ã€‚ã€Œè³¼å…¥Ã—1ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¢ãƒŠãƒªã‚¹ãƒˆã‚’æ¡ç”¨', highlight:'buy-analyst' };
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—3.5: ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆã®èª¬æ˜ï¼ˆã‚¢ãƒŠãƒªã‚¹ãƒˆè³¼å…¥å¾Œã€ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆãŒå°‘ã—ãŸã¾ã£ãŸã‚‰ï¼‰
        // ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã¾ã§è¡¨ç¤ºã‚’ç¶­æŒï¼ˆæ¡ä»¶ãŒå¤‰ã‚ã£ã¦ã‚‚è¡¨ç¤ºã—ç¶šã‘ã‚‹ï¼‰
        if(hasAnalyst && researchUnlocked && state.research > 0 && state.research < 25 && !hasBeta && !guidanceSkipped.has('research-explanation')) {
          return { text:'ä¸Šã®ã€ŒğŸ”¬ ãƒªã‚µãƒ¼ãƒã€ã‚’è¦‹ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ¼ã‚¿ãŒç ”ç©¶ãƒã‚¤ãƒ³ãƒˆã«å¤‰æ›ã•ã‚Œã¦ã„ã¾ã™ã€‚', highlight:'header-research', skipable:true, skipKey:'research-explanation' };
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã‚²ãƒ¼ã‚¸ã®èª¬æ˜ï¼ˆã‚¢ãƒŠãƒªã‚¹ãƒˆè³¼å…¥å¾Œã€RESEARCHãŒä¸€å®šãŸã¾ã£ãŸã‚‰ï¼‰
        // ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã¾ã§è¡¨ç¤ºã‚’ç¶­æŒï¼ˆç ”ç©¶ãƒã‚¤ãƒ³ãƒˆãŒ20ã‚’è¶…ãˆã¦ã‚‚è¡¨ç¤ºã—ç¶šã‘ã‚‹ï¼‰
        if(hasAnalyst && researchUnlocked && state.research >= 10 && !hasBeta && !guidanceSkipped.has('factor-gauge-explanation') && guidanceSkipped.has('research-explanation')) {
          return { text:'ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆãŒä¸€å®šè²¯ã¾ã‚Œã°å¸‚å ´ã®æ³•å‰‡ã€Œãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã€ã‚’ç™ºè¦‹ã§ãã¾ã™ã€‚ä¸Šã®ã‚²ãƒ¼ã‚¸ã‚’è¦‹ã¦ãã ã•ã„ã€‚', highlight:'factor-gauge', skipable:true, skipKey:'factor-gauge-explanation' };
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—6: ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ç™ºè¦‹ã‚’ä¿ƒã™ï¼ˆã‚¢ãƒŠãƒªã‚¹ãƒˆè³¼å…¥å¾Œã€ã¾ã Betaæœªç™ºè¦‹ï¼‰
        // å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆ3.5ã¨4ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯ã‚¹ã‚­ãƒƒãƒ—æ¸ˆã¿ã®å ´åˆã«è¡¨ç¤º
        if(!hasBeta && hasAnalyst && researchUnlocked) {
          const step3_5Visible = !guidanceSkipped.has('research-explanation') && state.research > 0;
          const step4Visible = !guidanceSkipped.has('factor-gauge-explanation') && guidanceSkipped.has('research-explanation') && state.research >= 10;
          if(!step3_5Visible && !step4Visible) {
            return { text:'ã‚¢ãƒŠãƒªã‚¹ãƒˆãŒè‡ªå‹•ã§RESEARCHã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚Betaã‚’ç™ºè¦‹ã—ã‚ˆã†', highlight:'factor-gauge' };
          }
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—7: é‹ç”¨æˆ¦ç•¥ã‚¿ãƒ–ã‚’ä¿ƒã™ï¼ˆãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ç™ºè¦‹å¾Œã€ã™ãã«è¡¨ç¤ºï¼‰
        if(hasBeta && !strategyUnlocked) {
          return { text:'ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã‚’ç™ºè¦‹ã—ã¾ã—ãŸï¼å¸‚å ´ã®ä»•çµ„ã¿ã‚’ä¸€ã¤è§£æ˜ã—ãŸã®ã§ã€é‹ç”¨æˆ¦ç•¥ã‚¿ãƒ–ã‚’é–‹ãã¾ã—ã‚‡ã†', highlight:'tab-strategy' };
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—7.5: STRATã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã‚’ä¿ƒã™ï¼ˆæˆ¦ç•¥ã‚¿ãƒ–ãŒã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¸ˆã¿ã€ã¾ã STRATã‚¿ãƒ–ã«ã„ãªã„ï¼‰
        if(strategyUnlocked && activeTab !== 'strategy' && !hasIndexFund) {
          return { text:'é‹ç”¨æˆ¦ç•¥ã‚¿ãƒ–ã‚’é–‹ãã¾ã—ã‚‡ã†ã€‚ä¸Šã®ã€ŒğŸ“ˆ æˆ¦ç•¥ã€ã‚¿ãƒ–ã‚’ã‚¿ãƒƒãƒ—', highlight:'tab-strategy' };
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—8: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ãƒ³ãƒ‰è³¼å…¥ã‚’ä¿ƒã™ï¼ˆSTRATã‚¿ãƒ–ã«ã„ã‚‹ï¼‰
        if(!hasIndexFund && strategyUnlocked && activeTab === 'strategy') {
          return { text:'ç™ºè¦‹ã—ãŸãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã‚’åˆ©ç”¨ã—ãŸæŠ•è³‡æˆ¦ç•¥ã‚’é–‹ç™ºã—ã¾ã—ã‚‡ã†ã€‚ã€Œé–‹ç™ºÃ—1ã€ãƒœã‚¿ãƒ³ã§é–‹ç™ºã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ãƒ³ãƒ‰ãŒãŸã¾ã«ãƒ­ãƒ¼ãƒ³ãƒã•ã‚ŒãŠé‡‘ã‚’é›†ã‚ã‚‰ã‚Œã¾ã™ã€‚', highlight:'buy-index_fund' };
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—8.5: é‹ç”¨è³‡ç”£ã®èª¬æ˜ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ãƒ³ãƒ‰è³¼å…¥å¾Œï¼‰
        // ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã¾ã§è¡¨ç¤ºã‚’ç¶­æŒï¼ˆæ•°å€¤ãŒå¤‰ã‚ã£ã¦ã‚‚è¡¨ç¤ºã—ç¶šã‘ã‚‹ï¼‰
        if(hasIndexFund && !guidanceSkipped.has('aum-explanation')) {
          return { text:'ä¸Šã®ã€ŒğŸ’° é‹ç”¨è³‡ç”£ã€ã‚’è¦‹ã¦ãã ã•ã„ã€‚ãƒ•ã‚¡ãƒ³ãƒ‰ã®é‹ç”¨ã§å°‘ã—ãšã¤ãŠé‡‘ãŒå¢—ãˆã¦ã„ã¾ã™ã€‚', highlight:'header-aum', skipable:true, skipKey:'aum-explanation' };
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—9: é‹ç”¨è³‡ç”£ãŒå¢—ãˆãŸã“ã¨ã‚’ç¢ºèªï¼ˆé‹ç”¨è³‡ç”£èª¬æ˜ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸå¾Œï¼‰
        // ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã¾ã§è¡¨ç¤ºã‚’ç¶­æŒ
        if(hasIndexFund && state.aum >= 1500 && !guidanceSkipped.has('aum-growth-confirm') && guidanceSkipped.has('aum-explanation')) {
          return { text:'ã•ã‚‰ã«ãƒ•ã‚¡ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒï¼ˆãŠé‡‘ã®ãƒãƒƒã‚°ï¼‰ã§ãŠé‡‘ã‚’ã•ã‚‰ã«ç²å¾—ã—ã¾ã™ã€‚', highlight:'header-aum', skipable:true, skipKey:'aum-growth-confirm' };
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—10: æ¬¡ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’ä¿ƒã™ï¼ˆé‹ç”¨è³‡ç”£ãŒååˆ†ã«å¢—ãˆãŸå¾Œï¼‰
        if(hasIndexFund && state.aum >= 2000 && (state.levels.scraper || 0) === 0) {
          if(activeTab !== 'data') {
            return { text:'ãƒ‡ãƒ¼ã‚¿åé›†ã‚’å¼·åŒ–ã—ã¾ã—ã‚‡ã†ã€‚ã€ŒğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã€ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã¦Webã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼ã‚’è³¼å…¥ã—ã¦ã¿ã¦ãã ã•ã„', highlight:'tab-data' };
          }
          return { text:'ã‚ˆã‚Šå¤šãã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†ã‚ã‚‹ãŸã‚ã«ã€Webã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼ã‚’è³¼å…¥ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã€Œè³¼å…¥Ã—1ã€ãƒœã‚¿ãƒ³ã§æ¬¡ã®ãƒ‡ãƒ¼ã‚¿åé›†ã‚«ãƒ¼ãƒ‰ã‚’è³¼å…¥', highlight:'buy-scraper' };
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—10.5: MLã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼è³¼å…¥ã‚’ä¿ƒã™ï¼ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼è³¼å…¥å¾Œï¼‰
        if(hasIndexFund && state.aum >= 2000 && (state.levels.scraper || 0) > 0 && (state.levels.ml_cluster || 0) === 0) {
          if(activeTab !== 'research') {
            return { text:'ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆç”Ÿæˆã‚’å¼·åŒ–ã—ã¾ã—ã‚‡ã†ã€‚ã€ŒğŸ”¬ ãƒªã‚µãƒ¼ãƒã€ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã¦MLã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’è³¼å…¥ã—ã¦ã¿ã¦ãã ã•ã„', highlight:'tab-research' };
          }
          return { text:'ã‚ˆã‚Šå¤šãã®ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ã€MLã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’è³¼å…¥ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã€Œè³¼å…¥Ã—1ã€ãƒœã‚¿ãƒ³ã§æ¬¡ã®ãƒªã‚µãƒ¼ãƒã‚«ãƒ¼ãƒ‰ã‚’è³¼å…¥', highlight:'buy-ml_cluster' };
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—11: ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†ã®ç¢ºèª
        if(hasIndexFund && state.aum >= 2000 && (state.levels.scraper || 0) > 0 && (state.levels.ml_cluster || 0) > 0) {
          if(guidanceSkipped.has('tutorial-complete')) return null;
          return { text:'ğŸ‰ åŸºæœ¬çš„ãªä»•çµ„ã¿ã‚’ç†è§£ã—ã¾ã—ãŸã€‚', highlight:null, skipable:true, skipKey:'tutorial-complete' };
        }
        
        return null; // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†
      }, [state, activeTab, guidanceSkipped, marketEvent]);

      // keep tab aligned during tutorial (ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ä¸­ã®ã¿æœ‰åŠ¹)
      const internLevel = state.levels.intern || 0;
      const analystLevel = state.levels.analyst || 0;
      const indexFundLevel = state.levels.index_fund || 0;
      const unlockedTabsStr2 = state.unlockedTabs.join(',');
      const prevUnlockedTabsRef = useRef(state.unlockedTabs);
      useEffect(() => {
        // ãƒªãƒãƒ¼ã‚¹å¾Œã¾ãŸã¯ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†å¾Œã¯ã‚¿ãƒ–ã®è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆã‚’ç„¡åŠ¹åŒ–ï¼ˆæ‰‹å‹•åˆ‡ã‚Šæ›¿ãˆã‚’è¨±å¯ï¼‰
        if(state.region > 0 || !guidance) {
          prevUnlockedTabsRef.current = [...state.unlockedTabs];
          return;
        }
        
        // DATAã‚¿ãƒ–: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ãŒ0ã®æ™‚ã®ã¿è‡ªå‹•ã§DATAã‚¿ãƒ–ã«æˆ»ã™
        if(internLevel === 0 && activeTab!=='data') {
          setActiveTab('data');
        }
        // RESEARCHã‚¿ãƒ–: ã‚¢ãƒŠãƒªã‚¹ãƒˆãŒ0ã§ã€researchã‚¿ãƒ–ãŒæ–°ã—ãã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®ã¿è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ
        // (æ—¢ã«ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¸ˆã¿ã®å ´åˆã¯è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆã—ãªã„)
        else if(state.unlockedTabs.includes('research') && analystLevel === 0 && activeTab!=='research') {
          const wasJustUnlocked = !prevUnlockedTabsRef.current.includes('research');
          if(wasJustUnlocked) {
            setActiveTab('research');
          }
        }
        // STRATEGYã‚¿ãƒ–: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ãƒ³ãƒ‰ãŒ0ã§ã€strategyã‚¿ãƒ–ãŒæ–°ã—ãã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®ã¿è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ
        else if(state.unlockedTabs.includes('strategy') && indexFundLevel === 0 && activeTab!=='strategy') {
          const wasJustUnlocked = !prevUnlockedTabsRef.current.includes('strategy');
          if(wasJustUnlocked) {
            setActiveTab('strategy');
          }
        }
        prevUnlockedTabsRef.current = [...state.unlockedTabs];
      }, [internLevel, analystLevel, indexFundLevel, unlockedTabsStr2, activeTab, state.unlockedTabs, state.region, guidance]);

      // calculate max purchasableï¼ˆæŒ‡æ•°é–¢æ•°çš„æˆé•·ã‚’è€ƒæ…®ï¼‰
      const calcMaxBuy = (u) => {
        // ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã®ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯
        const isLockedByFactor = u.category==='strategy' && !u.autoUpgrade && u.reqFactor && !state.discoveredFactorIds.includes(u.reqFactor);
        if(isLockedByFactor) return 0;
        
        // ãƒªãƒãƒ¼ã‚¹å›æ•°ã®ãƒã‚§ãƒƒã‚¯
        if(u.reqRegion !== undefined && state.region < u.reqRegion) return 0;
        
        const isTutorialComplete = state.region === 0 && (state.levels.index_fund || 0) > 0;
        const growthMultiplier = calcExponentialGrowth(1, state.discoveredFactorIds.length, state.region, isTutorialComplete);
        // æˆ¦ç•¥ã‚«ãƒ†ã‚´ãƒªã®å ´åˆã€æŒ‡æ•°é–¢æ•°çš„æˆé•·ã‚’é©ç”¨ï¼ˆãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å¾Œã€ãƒªãƒãƒ¼ã‚¹å¾Œï¼‰
        const costGrowth = (u.category === 'strategy' && (isTutorialComplete || state.region > 0)) ? growthMultiplier : 1.0;
        
        let count = 0;
        let totalCostA = 0;
        let totalCostR = 0;
        let currentLvl = state.levels[u.id] || 0;
        
        while(true){
          let costA = calcCost(u.baseCostAum || 0, u.costFactor, currentLvl + count);
          let costR = calcCost(u.baseCostResearch || 0, u.costFactor, currentLvl + count);
          // æŒ‡æ•°é–¢æ•°çš„æˆé•·ã‚’é©ç”¨
          if(costGrowth > 1.0) {
            costA *= costGrowth;
            costR *= costGrowth;
          }
          if(state.aum < totalCostA + costA || state.research < totalCostR + costR) break;
          totalCostA += costA;
          totalCostR += costR;
          count++;
          if(count >= 1000) break; // safety limit
        }
        return count;
      };

      // purchase
      const buy = (u, amount) => {
        const lvl = state.levels[u.id] || 0;
        if(amount <= 0) return;
        
        // ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã®ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯
        const isLockedByFactor = u.category==='strategy' && !u.autoUpgrade && u.reqFactor && !state.discoveredFactorIds.includes(u.reqFactor);
        if(isLockedByFactor) return;
        
        // ãƒªãƒãƒ¼ã‚¹å›æ•°ã®ãƒã‚§ãƒƒã‚¯
        if(u.reqRegion !== undefined && state.region < u.reqRegion) return;
        
        const isTutorialComplete = state.region === 0 && (state.levels.index_fund || 0) > 0;
        const growthMultiplier = calcExponentialGrowth(1, state.discoveredFactorIds.length, state.region, isTutorialComplete);
        // æˆ¦ç•¥ã‚«ãƒ†ã‚´ãƒªã®å ´åˆã€æŒ‡æ•°é–¢æ•°çš„æˆé•·ã‚’é©ç”¨ï¼ˆãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å¾Œã€ãƒªãƒãƒ¼ã‚¹å¾Œï¼‰
        const costGrowth = (u.category === 'strategy' && (isTutorialComplete || state.region > 0)) ? growthMultiplier : 1.0;
        
        let totalCostA = 0;
        let totalCostR = 0;
        for(let i = 0; i < amount; i++){
          let costA = calcCost(u.baseCostAum || 0, u.costFactor, lvl + i);
          let costR = calcCost(u.baseCostResearch || 0, u.costFactor, lvl + i);
          // æŒ‡æ•°é–¢æ•°çš„æˆé•·ã‚’é©ç”¨
          if(costGrowth > 1.0) {
            costA *= costGrowth;
            costR *= costGrowth;
          }
          totalCostA += costA;
          totalCostR += costR;
        }
        
        if(state.aum < totalCostA || state.research < totalCostR) return;
        
        const isFirstPurchase = lvl === 0;
        const newLvl = lvl + amount;
        
        setState(p => ({
          ...p,
          aum: (p.aum||0) - totalCostA,
          research: Math.max(0, (p.research||0) - totalCostR),
          levels: {...p.levels, [u.id]: newLvl}
        }));
        
        if(isFirstPurchase){
          // æ¼”å‡ºï¼ˆåˆå›è³¼å…¥ã®ã¿ï¼‰
          const x = window.innerWidth/2;
          const y = window.innerHeight/2;
          setModal({
            title: 'âœ¨ æ–°è¦æ¡ç”¨ï¼ âœ¨',
            body: `${u.name}ã‚’æ¡ç”¨ã—ã¾ã—ãŸï¼

${u.desc}

æ–°ã—ã„ãƒ‘ãƒ¯ãƒ¼ãŒè§£ç¦ã•ã‚Œã¾ã™ã€‚`,
            buttonText: 'ğŸš€ ç¶šã‘ã‚‹',
            icon: u.icon,
            onConfirm: () => setModal(null)
          });
          setTimeout(() => spawnFloat(u.icon, '#fbbf24', x, y), 100);
          setTimeout(() => spawnFloat('NEW!', '#4ade80', x, y - 20), 200);
          setTimeout(() => spawnFloat(u.name, '#60a5fa', x, y - 40), 300);
        } else if(amount > 1){
          const x = window.innerWidth/2;
          const y = window.innerHeight/2;
          spawnFloat(`+${amount}`, '#fbbf24', x, y);
          setTimeout(() => spawnFloat(`Lv.${newLvl}`, '#fbbf24', x, y - 20), 150);
        }
      };

      // actions
      const onReverse = () => {
        // ãƒªãƒãƒ¼ã‚¹æ¡ä»¶: AlphaOmegaãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ç™ºè¦‹ + æœ€ä½é™ã®æˆé•·ãŒå¿…è¦
        if(!state.discoveredFactorIds.includes('alphaomega')) return;
        // å¾ŒåŠã®ã‚«ãƒ¼ãƒ‰ã®ã‚ã‚ŠãŒãŸã¿ã‚’æ„Ÿã˜ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã€ã‚ã‚‹ç¨‹åº¦ã®æˆé•·ãŒå¿…è¦
        const minAum = 1000000000; // 10å„„ä»¥ä¸Š
        if(state.aum < minAum) {
          setModal({
            title: 'âš ï¸ ãƒªãƒãƒ¼ã‚¹æ¡ä»¶æœªé”æˆ',
            body: `æ–°ã—ã„æƒ‘æ˜Ÿã¸ã®æŠ•è³‡ã«ã¯ã€ã‚ˆã‚Šå¤šãã®é‹ç”¨è³‡ç”£ãŒå¿…è¦ã§ã™ã€‚

ç¾åœ¨ã®é‹ç”¨è³‡ç”£: ${fmt(state.aum)}
å¿…è¦é‹ç”¨è³‡ç”£: ${fmt(minAum)}

ã‚‚ã£ã¨æˆé•·ã—ã¦ã‹ã‚‰å†æŒ‘æˆ¦ã—ã¦ãã ã•ã„ï¼`,
            buttonText: 'äº†è§£',
            icon: 'âš ï¸',
            onConfirm: () => setModal(null)
          });
          return;
        }
        setModal({
          title: 'ğŸš€ æ–°æƒ‘æ˜Ÿã¸ã®æŠ•è³‡ ğŸš€',
          body: `${state.region === 0 ? 'åœ°çƒã‚’å‡ºã¦' : ''}æ–°ã—ã„æƒ‘æ˜Ÿã¸ã®æŠ•è³‡ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ

âš ï¸ ç¾åœ¨ã®é‹ç”¨è³‡ç”£ã€è¨­å‚™ã€ãƒ‡ãƒ¼ã‚¿ã€ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆã¯
ã™ã¹ã¦å¤±ã‚ã‚Œã¾ã™ã€‚

âœ¨ ã—ã‹ã—ã€æ¬¡ã®æƒ‘æ˜Ÿã§ã¯ãƒ•ã‚¡ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒã§ç²å¾—ã§ãã‚‹ãŠé‡‘ãŒå¢—ãˆã€
ã‚ˆã‚Šå¼·åŠ›ãªæˆé•·ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï¼`,
          buttonText: 'ğŸš€ å‚å…¥é–‹å§‹',
          icon: 'ğŸŒ',
          onConfirm: () => {
            const nextRegion = state.region + 1;
            setState(p => ({
              ...p,
              region: nextRegion,
              noise: 0,
              research: 0,
              aum: 1000,
              levels: {},
              unlockedTabs: ['data', 'research', 'strategy'], // ãƒªãƒãƒ¼ã‚¹å¾Œã¯å…¨ã‚¿ãƒ–ã‚’è¡¨ç¤º
              discoveredFactorIds: [],
              fundraiseCount: 0,
            }));
            setActiveTab('data');
            setModal(null);
            // ãƒªãƒãƒ¼ã‚¹æ¼”å‡º
            setTimeout(() => spawnFloat('ğŸš€', '#ffffff', window.innerWidth/2, window.innerHeight/2), 100);
            setTimeout(() => spawnFloat('NEW PLANET!', '#ffffff', window.innerWidth/2, window.innerHeight/2 + 30), 200);
            setTimeout(() => spawnFloat(`æƒ‘æ˜Ÿ${nextRegion + 1}`, '#ffffff', window.innerWidth/2, window.innerHeight/2 + 60), 300);
          }
        });
      };

      // main loop (100ms)
      useEffect(() => {
        if(state.phase !== 'running') return;

        const spawnOpp = setInterval(() => {
          const gs = stateRef.current;
          const lv = gs.levels;
          const strats = UPGRADES.filter(u => u.category==='strategy' && (lv[u.id]>0));
          if(strats.length===0) return;

          const spectrumEl = document.getElementById('spectrum-area');
          const w = spectrumEl ? spectrumEl.clientWidth : 360;

          // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†åˆ¤å®šï¼ˆæ©Ÿä¼šç”Ÿæˆé »åº¦ã‚‚å‰Šæ¸›ï¼‰
          const isTutorialComplete = gs.region === 0 && (lv['index_fund'] || 0) > 0;
          const growthPenalty = (isTutorialComplete || gs.region > 0) ? 0.5 : 1.0;

          const strat = strats[(Math.random()*strats.length)|0];
          const lvl = lv[strat.id] || 0;
          const freq = (strat.frequency||0.05) * 4 * Math.pow(1.1, lvl) * growthPenalty;

          if(Math.random() < freq){
            const f = FACTORS.find(x => x.id===strat.reqFactor) || {color:'#fff'};
            const baseVal = calcValue(strat.baseValue || 1, lvl);
            // ãƒªãƒãƒ¼ã‚¹å›æ•°ã«å¿œã˜ã¦ãƒ•ã‚¡ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒå€¤ãŒå¢—ãˆã‚‹ï¼ˆãƒªãƒãƒ¼ã‚¹ã®ä¸»ãªåŠ¹æœï¼‰
            // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ä¸­ãƒ»å®Œäº†å¾Œã§ã‚‚ãƒªãƒãƒ¼ã‚¹ã—ã¦ã„ãªã„å ´åˆã¯ä¹—æ•°ãªã—
            const regionMultiplier = gs.region > 0 ? Math.pow(2.0, gs.region) : 1.0;
            const val = baseVal * regionMultiplier;
            setOpps(p => (p.length>18 ? p : [...p, {id:Date.now()+Math.random(), x:w+40, color:f.color, val, status:'moving', scale:1}]));
          }
        }, 300);

        const tick = setInterval(() => {
          if(modal) return;

          // always define now (fix)
          const now = Date.now();
          const dt = clampDt((now - (lastLoopRef.current || now)) / 1000);
          lastLoopRef.current = now;

          const gs = stateRef.current;

          // move & (auto) collect opportunities
          const spectrumEl = document.getElementById('spectrum-area');
          const w = spectrumEl ? spectrumEl.clientWidth : 360;
          const centerX = w/2;

          setOpps(prev => {
            let collected = 0;
            let launched = 0;
            const spawned = [];
            const next = [];

            for(const op of prev){
              if(op.status==='exploding'){
                if(op.scale < 2.4) next.push({...op, scale: op.scale + 0.22});
                else {
                  if(spectrumEl){
                    const r = spectrumEl.getBoundingClientRect();
                    spawned.push({x:r.left+op.x, y:r.top+r.height/2, val:op.val});
                  }
                }
                continue;
              }

              const nextX = op.x - (120*dt);
              // å¸¸ã«è‡ªå‹•ã§ãƒ•ã‚¡ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒï¼ˆAUTOãƒœã‚¿ãƒ³ä¸è¦ã€ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆä¸è¦ï¼‰
              const near = (op.x >= centerX-8 && nextX <= centerX+8);
              if(near){
                // ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆã®ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤ã€å˜ç´”ã«ãŠé‡‘ãŒå…¥ã‚‹ã ã‘
                collected += op.val;
                launched++;
                next.push({...op, x:centerX, status:'exploding', scale:1.2});
                continue;
              }

              if(nextX > -60) next.push({...op, x:nextX});
            }

            for(const e of spawned){
              spawnFly(e.x, e.y);
              // ãƒ•ã‚¡ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒã®ãƒ†ã‚­ã‚¹ãƒˆã¨é‡‘é¡ã‚’è¡¨ç¤º
              spawnFloat('ãƒ•ã‚¡ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒ', '#fbbf24', e.x, e.y - 20);
              spawnFloat(`+ğŸ’°${fmt(e.val)}`, '#fbbf24', e.x, e.y);
            }

            if(collected>0){
              setState(p => ({
                ...p,
                aum:(p.aum||0)+collected,
                fundraiseCount:(p.fundraiseCount||0)+launched,
              }));
            }

            return next;
          });

          // passive updates
          setState(prev => {
            const r = calcRates(prev);
            let next = {...prev};

            // æˆ¦ç•¥ã®åˆ†æ•£åº¦ï¼ˆä½¿ç”¨ã—ã¦ã„ã‚‹ç•°ãªã‚‹ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼æ•°ã«åŸºã¥ãï¼‰
            const strategies = UPGRADES.filter(u => u.category === 'strategy' && (prev.levels[u.id] || 0) > 0);
            
            // ä½¿ç”¨ã—ã¦ã„ã‚‹æˆ¦ç•¥ãŒå¯¾å¿œã™ã‚‹ç•°ãªã‚‹ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const usedFactors = new Set();
            for(const s of strategies){
              if(s.reqFactor) usedFactors.add(s.reqFactor);
            }
            const uniqueFactorCount = usedFactors.size;
            const totalFactorCount = FACTORS.length; // å…¨ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼æ•°ï¼ˆ11å€‹ï¼‰
            
            // åˆ†æ•£åº¦: ä½¿ç”¨ã—ã¦ã„ã‚‹ç•°ãªã‚‹ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼æ•° / å…¨ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼æ•°
            // ä¸€ç¨®é¡ã®ãƒ•ã‚¡ãƒ³ãƒ‰ã‚’å¼·åŒ–ã—ã¦ã‚‚åˆ†æ•£åº¦ã¯ä¸ŠãŒã‚‰ãªã„
            const diversification = totalFactorCount > 0 ? uniqueFactorCount / totalFactorCount : 0;
            
            // ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†
            const now = Date.now();
            let eventMultiplier = 1;
            let eventText = null;
            
            // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿãƒã‚§ãƒƒã‚¯ï¼ˆMomentumãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ç™ºè¦‹å¾Œã€60ç§’ã”ã¨ã«ç¢ºå®šç™ºç”Ÿï¼‰
            const hasMomentum = prev.discoveredFactorIds.includes('momentum');
            
            // åˆå›ã¾ãŸã¯å†é–‹æ™‚ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
            if(hasMomentum && nextEventTimeRef.current === null && !marketEvent){
               nextEventTimeRef.current = now + 60000;
            }

            if(hasMomentum && (!marketEvent || now - marketEvent.startTime > marketEvent.duration * 1000)){
              // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³å®Œäº†ã§ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
              if(nextEventTimeRef.current && now >= nextEventTimeRef.current){
                const isCrash = Math.random() < 0.5;
                const duration = 3 + Math.random() * 5; // 3-8ç§’ã«çŸ­ç¸®
                const newEvent = {
                  type: isCrash ? 'crash' : 'fever',
                  duration: duration,
                  startTime: now
                };
                setMarketEvent(newEvent);

                // ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚ã®æ¼”å‡ºï¼ˆç”»é¢ä¸­å¤®ã¨é‹ç”¨è³‡ç”£ä»˜è¿‘ã«ãƒ•ãƒ­ãƒ¼ãƒˆè¡¨ç¤ºï¼‰
                const label = isCrash ? 'ğŸ“‰ ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¯ãƒ©ãƒƒã‚·ãƒ¥ï¼' : 'ğŸ“ˆ ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ•ã‚£ãƒ¼ãƒãƒ¼ï¼';
                spawnFloat(label, isCrash ? '#f97373' : '#4ade80', window.innerWidth/2, window.innerHeight/2 - 40);
                const aumEl = document.getElementById('aum-anchor');
                if(aumEl){
                  const r = aumEl.getBoundingClientRect();
                  spawnFloat(label, isCrash ? '#f97373' : '#4ade80', r.left + r.width/2, r.top - 10);
                }

                // ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’ä¸€åº¦ã ã‘èµ·å‹•ï¼ˆã¾ã å®Œäº†ã—ã¦ãŠã‚‰ãšã€ã‹ã¤ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ãªã„å ´åˆã®ã¿è¨­å®šï¼‰
                // ã“ã‚Œã«ã‚ˆã‚Šã€åˆå›ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚ã«ç¢ºå®Ÿã«ãƒ•ãƒ©ã‚°ãŒç«‹ã¤
                if(!marketEventGuidanceDone && !marketEventGuidanceActive){
                  setMarketEventGuidanceActive(true);
                }
                
                // æ¬¡å›äºˆå®šã¯ã„ã£ãŸã‚“ã‚¯ãƒªã‚¢ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆçµ‚äº†æ™‚ã«å†è¨­å®šï¼‰
                nextEventTimeRef.current = null;
              }
            }
            
            // ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆåŠ¹æœã‚’è¨ˆç®—ï¼ˆãƒãƒ©ãƒ³ã‚¹èª¿æ•´ï¼šåŠ¹æœã‚’å¤§å¹…ã«å‰Šæ¸›ï¼‰
            if(marketEvent && now - marketEvent.startTime <= marketEvent.duration * 1000){
              const eventProgress = (now - marketEvent.startTime) / (marketEvent.duration * 1000);
              if(marketEvent.type === 'crash'){
                // ã‚¯ãƒ©ãƒƒã‚·ãƒ¥: -0.5%ï½-2%ã€åˆ†æ•£åº¦ã§è»½æ¸›ï¼ˆå¤§å¹…ã«å‰Šæ¸›ï¼‰
                const crashSeverity = 0.02 - (diversification * 0.015); // å®Œå…¨åˆ†æ•£ã§-0.5%ã€å®Œå…¨é›†ä¸­ã§-2%
                eventMultiplier = 1 - (crashSeverity * (0.5 + 0.5 * Math.sin(eventProgress * Math.PI))); // æ»‘ã‚‰ã‹ãªå¤‰åŒ–
                if(eventProgress < 0.1 || (eventProgress > 0.9 && Math.random() < 0.1)){
                  eventText = 'ğŸ“‰ ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¯ãƒ©ãƒƒã‚·ãƒ¥ç™ºç”Ÿï¼';
                }
              } else {
                // ãƒ•ã‚£ãƒ¼ãƒãƒ¼: +0.5%ï½+2%ã€åˆ†æ•£åº¦ã§å¢—å¹…ï¼ˆå¤§å¹…ã«å‰Šæ¸›ï¼‰
                const feverStrength = 0.005 + (diversification * 0.015); // å®Œå…¨åˆ†æ•£ã§+2%ã€å®Œå…¨é›†ä¸­ã§+0.5%
                eventMultiplier = 1 + (feverStrength * (0.5 + 0.5 * Math.sin(eventProgress * Math.PI)));
                if(eventProgress < 0.1 || (eventProgress > 0.9 && Math.random() < 0.1)){
                  eventText = 'ğŸ“ˆ ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ•ã‚£ãƒ¼ãƒãƒ¼ç™ºç”Ÿï¼';
                }
              }
            } else if(marketEvent && now - marketEvent.startTime > marketEvent.duration * 1000){
              // ã‚¤ãƒ™ãƒ³ãƒˆçµ‚äº†æ™‚ã€çµ‚äº†æ™‚åˆ»ã‚’è¨˜éŒ²
              setLastEventEndTime(now);
              setMarketEvent(null);
              // æ¬¡å›ã‚¤ãƒ™ãƒ³ãƒˆã‚’60ç§’å¾Œã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
              nextEventTimeRef.current = now + 60000;
            }
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
            if(eventText){
              spawnFloat(eventText, marketEvent.type === 'crash' ? '#ef4444' : '#4ade80', window.innerWidth/2, window.innerHeight/2);
            }
            
            // AUM passive (ã‚¤ãƒ™ãƒ³ãƒˆåŠ¹æœã‚’é©ç”¨)
            next.aum = (prev.aum||0) * (1 + r.passive * dt) * eventMultiplier;
            if(!Number.isFinite(next.aum)) next.aum = Number.MAX_VALUE;

            // DATA
            next.noise = (prev.noise||0) + r.dataProd * dt;

            // research production (consume DATA)
            let resGain = 0;
            for(const u of UPGRADES){
              if(u.category!=='research') continue;
              const lv = prev.levels[u.id]||0;
              if(lv<=0) continue;
              const cons = (u.inputNoise||0) * lv * dt;
              if(next.noise > cons){
                next.noise -= cons;
                resGain += (u.outputResearch||0) * lv * dt;
              }
            }
            next.research = (prev.research||0) + resGain;

            // factor discovery (é–¾å€¤è¨ˆç®—ã‚’çµ±ä¸€)
            const nf = FACTORS.find(f => !prev.discoveredFactorIds.includes(f.id));
            if(nf){
              // getFactorThresholdã¨åŒã˜è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨
              const isTutorialComplete = prev.region === 0 && ((prev.levels.index_fund || 0) > 0);
              let threshold;
              if(prev.region === 0) {
                if(isTutorialComplete) {
                  const growth = calcExponentialGrowth(1, prev.discoveredFactorIds.length, 0, true);
                  threshold = nf.threshold * growth;
                } else {
                  threshold = nf.threshold;
                }
              } else {
                const baseIncrease = 1.0 + (prev.region * 0.1);
                threshold = nf.threshold * baseIncrease;
              }
              if(next.research >= threshold){
                next.discoveredFactorIds = [...prev.discoveredFactorIds, nf.id];
              }
            }

            // keep finite
            if(!Number.isFinite(next.noise)) next.noise = 0;
            if(!Number.isFinite(next.research)) next.research = 0;
            
            // è‡ªå‹•è³¼å…¥å‡¦ç†ï¼ˆ1ç§’ã”ã¨ï¼‰
            const autoBuyInterval = 1000; // 1ç§’
            const hasAutoData = (prev.levels.auto_upgrade_data || 0) > 0;
            const hasAutoResearch = (prev.levels.auto_upgrade_research || 0) > 0;
            const hasAutoStrategy = (prev.levels.auto_upgrade_strategy || 0) > 0;
            
            if((hasAutoData || hasAutoResearch || hasAutoStrategy) && now - (lastAutoBuyRef.current.lastTime || 0) >= autoBuyInterval){
              lastAutoBuyRef.current.lastTime = now;
              
              // è‡ªå‹•ãƒ‡ãƒ¼ã‚¿åé›†: ãƒ‡ãƒ¼ã‚¿ã‚«ãƒ†ã‚´ãƒªã®ã‚«ãƒ¼ãƒ‰ã‚’è‡ªå‹•è³¼å…¥
              if(hasAutoData){
                const dataUpgrades = UPGRADES.filter(u => 
                  u.category === 'data' && 
                  !u.autoUpgrade && 
                  (u.reqRegion === undefined || prev.region >= u.reqRegion)
                );
                // ã‚³ã‚¹ãƒˆãŒä½ã„é †ã«ã‚½ãƒ¼ãƒˆ
                dataUpgrades.sort((a, b) => {
                  const costA = calcCost(a.baseCostAum || 0, a.costFactor, prev.levels[a.id] || 0);
                  const costB = calcCost(b.baseCostAum || 0, b.costFactor, prev.levels[b.id] || 0);
                  return costA - costB;
                });
                
                for(const u of dataUpgrades){
                  const lvl = prev.levels[u.id] || 0;
                  const costA = calcCost(u.baseCostAum || 0, u.costFactor, lvl);
                  const costR = calcCost(u.baseCostResearch || 0, u.costFactor, lvl);
                  if(next.aum >= costA && next.research >= costR){
                    next.aum -= costA;
                    next.research = Math.max(0, next.research - costR);
                    next.levels = {...next.levels, [u.id]: lvl + 1};
                    break; // 1å›ã®ãƒ«ãƒ¼ãƒ—ã§1ã¤ã ã‘è³¼å…¥
                  }
                }
              }
              
              // è‡ªå‹•ãƒªã‚µãƒ¼ãƒ: ãƒªã‚µãƒ¼ãƒã‚«ãƒ†ã‚´ãƒªã®ã‚«ãƒ¼ãƒ‰ã‚’è‡ªå‹•è³¼å…¥
              if(hasAutoResearch){
                const researchUpgrades = UPGRADES.filter(u => 
                  u.category === 'research' && 
                  !u.autoUpgrade && 
                  (u.reqRegion === undefined || prev.region >= u.reqRegion)
                );
                researchUpgrades.sort((a, b) => {
                  const costA = calcCost(a.baseCostAum || 0, a.costFactor, prev.levels[a.id] || 0);
                  const costB = calcCost(b.baseCostAum || 0, b.costFactor, prev.levels[b.id] || 0);
                  return costA - costB;
                });
                
                for(const u of researchUpgrades){
                  const lvl = prev.levels[u.id] || 0;
                  const costA = calcCost(u.baseCostAum || 0, u.costFactor, lvl);
                  const costR = calcCost(u.baseCostResearch || 0, u.costFactor, lvl);
                  if(next.aum >= costA && next.research >= costR){
                    next.aum -= costA;
                    next.research = Math.max(0, next.research - costR);
                    next.levels = {...next.levels, [u.id]: lvl + 1};
                    break;
                  }
                }
              }
              
              // è‡ªå‹•æˆ¦ç•¥æœ€é©åŒ–: æˆ¦ç•¥ã‚«ãƒ†ã‚´ãƒªã®ã‚«ãƒ¼ãƒ‰ã‚’è‡ªå‹•è³¼å…¥
              if(hasAutoStrategy){
                const strategyUpgrades = UPGRADES.filter(u => 
                  u.category === 'strategy' && 
                  !u.autoUpgrade && 
                  (u.reqFactor === undefined || prev.discoveredFactorIds.includes(u.reqFactor)) &&
                  (u.reqRegion === undefined || prev.region >= u.reqRegion)
                );
                strategyUpgrades.sort((a, b) => {
                  const costA = calcCost(a.baseCostAum || 0, a.costFactor, prev.levels[a.id] || 0);
                  const costB = calcCost(b.baseCostAum || 0, b.costFactor, prev.levels[b.id] || 0);
                  return costA - costB;
                });
                
                for(const u of strategyUpgrades){
                  const lvl = prev.levels[u.id] || 0;
                  const costA = calcCost(u.baseCostAum || 0, u.costFactor, lvl);
                  const costR = calcCost(u.baseCostResearch || 0, u.costFactor, lvl);
                  if(next.aum >= costA && next.research >= costR){
                    next.aum -= costA;
                    next.research = Math.max(0, next.research - costR);
                    next.levels = {...next.levels, [u.id]: lvl + 1};
                    break;
                  }
                }
              }
            }
            
            return next;
          });

        }, 100);

        return () => { clearInterval(tick); clearInterval(spawnOpp); };
      }, [state.phase, modal, spawnFly, spawnFloat, marketEvent]);

      // tab labels
      const tabs = useMemo(() => Array.from(new Set(state.unlockedTabs)), [state.unlockedTabs]);

      const tabLabel = (t) => t==='data' ? 'ğŸ’¾ ãƒ‡ãƒ¼ã‚¿' : t==='research' ? 'ğŸ”¬ ãƒªã‚µãƒ¼ãƒ' : 'ğŸ“ˆ æˆ¦ç•¥';

      const isStalled = rates.dataCons>0 && state.noise < 1 && rates.netData < 0;
      const progress = useMemo(() => nextFactor ? Math.min(100, (state.research/nextFactor.threshold)*100) : 100, [state.research, nextFactor]);
      
      // åˆ†æ•£åŠ¹æœã‚’è¨ˆç®—ï¼ˆå®Ÿéš›ã«ä½¿ç”¨ã—ã¦ã„ã‚‹æˆ¦ç•¥ã®ç¨®é¡æ•°ã«åŸºã¥ãï¼‰
      const diversificationInfo = useMemo(() => {
        const strategies = UPGRADES.filter(u => u.category === 'strategy' && (state.levels[u.id] || 0) > 0);
        const strategyCount = strategies.length;
        
        // ä½¿ç”¨ã—ã¦ã„ã‚‹æˆ¦ç•¥ãŒå¯¾å¿œã™ã‚‹ç•°ãªã‚‹ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        const usedFactors = new Set();
        for(const s of strategies){
          if(s.reqFactor) usedFactors.add(s.reqFactor);
        }
        const uniqueFactorCount = usedFactors.size;
        const totalFactorCount = FACTORS.length; // å…¨ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼æ•°ï¼ˆ11å€‹ï¼‰
        
        // åˆ†æ•£åº¦ã¯ä½¿ç”¨ã—ã¦ã„ã‚‹ç•°ãªã‚‹ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼æ•° / å…¨ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼æ•°
        // ä¸€ç¨®é¡ã®ãƒ•ã‚¡ãƒ³ãƒ‰ã‚’å¼·åŒ–ã—ã¦ã‚‚åˆ†æ•£åº¦ã¯ä¸ŠãŒã‚‰ãªã„
        const diversification = totalFactorCount > 0 ? uniqueFactorCount / totalFactorCount : 0;
        
        return { diversification, strategyCount };
      }, [state.levels, state.discoveredFactorIds]);
      
      // ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¤ãƒ™ãƒ³ãƒˆã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¨ˆç®—
      const eventCountdown = useMemo(() => {
        const hasMomentum = state.discoveredFactorIds.includes('momentum');
        if(!hasMomentum) return null;
        
        const now = currentTime;
        if(marketEvent && now - marketEvent.startTime <= marketEvent.duration * 1000){
          // ã‚¤ãƒ™ãƒ³ãƒˆä¸­
          const remaining = (marketEvent.duration * 1000) - (now - marketEvent.startTime);
          return { active: true, remaining: remaining / 1000, type: marketEvent.type };
        } else {
          // æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã¾ã§ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼ˆç¢ºå®š60ç§’ï¼‰
          if (nextEventTimeRef.current) {
             const remaining = Math.max(0, (nextEventTimeRef.current - now) / 1000);
             return { active: false, remaining: remaining, avgInterval: 60 };
          }
          
          // ã¾ã ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆï¼ˆé€šå¸¸ã¯ã“ã“ã«ã¯æ¥ãªã„ãŒã€åˆæœŸåŒ–å¾…ã¡ãªã©ï¼‰
          return { active: false, remaining: 60, avgInterval: 60 };
        }
      }, [marketEvent, state.discoveredFactorIds, currentTime]);

      return (
        <ErrorBoundary>
          <div className="h-screen w-full flex flex-col relative overflow-hidden">

            {/* HEADER */}
            <div className="z-30 bg-[#0f172a]/95 backdrop-blur border-b border-gray-800 p-2 shadow-lg shrink-0">
              {state.region > 0 && (
                <div className="text-center mb-1">
                  <div className="inline-block px-3 py-1 bg-purple-900/40 border border-purple-500/50 rounded-full">
                    <span className="text-[11px] font-mono font-bold text-purple-300">{state.region === 0 ? 'ğŸŒ åœ°çƒ' : `ğŸš€ æƒ‘æ˜Ÿ ${state.region + 1}`}</span>
                  </div>
                </div>
              )}
              <div className="flex justify-between items-end">
                <div className="flex gap-3">
                  <ResourceItem
                    label="ğŸ’¾ ãƒ‡ãƒ¼ã‚¿"
                    value={fmt(state.noise)}
                    subValue={`(${rates.netData>=0?'+':''}${fmt(rates.netData)}/s)`}
                    subColor={rates.netData>=0?'text-green-500':'text-red-500'}
                    highlight={guidance?.highlight==='header-data'}
                  />
                  {state.unlockedTabs.includes('research') && (
                  <ResourceItem
                    label="ğŸ”¬ ãƒªã‚µãƒ¼ãƒ"
                    value={fmt(state.research)}
                    subValue={isStalled ? `ãƒ‡ãƒ¼ã‚¿ä¸è¶³ (-${fmt(Math.abs(rates.netData))}/s)` : `(+${fmt(rates.resProd)}/s)  ãƒ‡ãƒ¼ã‚¿â†’ãƒªã‚µãƒ¼ãƒ`}
                      subColor={isStalled ? 'text-red-400 font-bold' : 'text-blue-300'}
                      highlight={guidance?.highlight==='header-research'}
                    />
                  )}
                </div>
                <div className="text-right">
                  <div className={`flex flex-col items-end relative ${guidance?.highlight==='header-aum' ? 'hl' : ''}`}>
                    <div id="aum-anchor" className="text-[10px] text-gray-500 font-mono tracking-widest">ğŸ’° é‹ç”¨è³‡ç”£</div>
                    {guidance?.highlight==='header-aum' && <div className="arrow">ğŸ‘‡</div>}
                    <div className="text-2xl font-mono text-white font-bold leading-none">
                      <span className="text-gray-500 text-lg mr-1">$</span>{fmt(state.aum)}
                    </div>
                    <div className="text-[10px] font-mono text-green-400">(+{(rates.passive*100).toFixed(2)}%/s)</div>
                  </div>
                </div>
              </div>

              {/* ticker */}
              <div className="mt-2 w-full bg-black/60 border border-gray-800 h-6 flex items-center overflow-hidden relative rounded">
                <div className="whitespace-nowrap text-xs font-mono text-blue-400 animate-[ticker_18s_linear_infinite] px-4">{ticker}</div>
              </div>

              {/* factor progress */}
              {nextFactor ? (
                <div id="factor-gauge" className={`w-full flex items-center gap-2 mt-2 relative ${guidance?.highlight==='factor-gauge' ? 'hl' : ''}`}>
                  <div className="text-[10px] text-gray-400 font-mono whitespace-nowrap">æ¬¡ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼: {nextFactor.name}</div>
                  <div className={`flex-1 h-1.5 bg-gray-800 rounded-full overflow-hidden border border-gray-700 ${isStalled?'bg-red-900/20':''}`}>
                    <div className="bg-gradient-to-r from-blue-600 to-purple-500 h-full" style={{width:`${progress}%`}}></div>
                  </div>
                  <div className="text-[10px] text-gray-500 font-mono">{fmt(nextFactor.threshold)} ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆ</div>
                  {guidance?.highlight==='factor-gauge' && <div className="arrow">ğŸ‘‡</div>}
                </div>
              ) : state.discoveredFactorIds.length >= FACTORS.length ? (
                <div className="w-full flex items-center justify-center gap-2 mt-2">
                  <div className="text-[10px] text-gray-400 font-mono">âœ¨ ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã‚’ç™ºè¦‹ã—ã¾ã—ãŸï¼ âœ¨</div>
                </div>
              ) : null}
              
              {/* åˆ†æ•£åŠ¹æœã¨ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ± */}
              {diversificationInfo.strategyCount > 0 && (
                <div id="diversification-info" className={`w-full flex items-center justify-between gap-2 mt-2 text-[10px] font-mono relative ${guidance?.highlight==='diversification-info' ? 'hl' : ''}`}>
                  <div className="flex items-center gap-2">
                    <span className="text-gray-400">åˆ†æ•£åº¦:</span>
                    <div className="flex-1 bg-gray-800 rounded-full h-1.5 max-w-[120px] overflow-hidden border border-gray-700">
                      <div className="bg-gradient-to-r from-green-600 to-blue-500 h-full" style={{width:`${(diversificationInfo.diversification * 100).toFixed(0)}%`}}></div>
                    </div>
                    <span className="text-gray-300">{(diversificationInfo.diversification * 100).toFixed(0)}%</span>
                    <span className="text-gray-500">({diversificationInfo.strategyCount}æˆ¦ç•¥)</span>
                  </div>
                  {guidance?.highlight==='diversification-info' && <div className="arrow">ğŸ‘‡</div>}
                  {eventCountdown && (
                    <div id="event-countdown" className={`flex items-center gap-1 relative ${eventCountdown.active ? (eventCountdown.type === 'crash' ? 'text-red-400' : 'text-green-400') : 'text-gray-400'} ${guidance?.highlight==='event-countdown' ? 'hl' : ''}`}>
                      {eventCountdown.active ? (
                        <>
                          <span>{eventCountdown.type === 'crash' ? 'ğŸ“‰' : 'ğŸ“ˆ'}</span>
                          <span>{(eventCountdown.remaining || 0).toFixed(1)}s</span>
                        </>
                      ) : (
                        <span>æ¬¡å›ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿã¾ã§: {eventCountdown.remaining ? eventCountdown.remaining.toFixed(1) : eventCountdown.avgInterval}ç§’</span>
                      )}
                      {guidance?.highlight==='event-countdown' && <div className="arrow">ğŸ‘‡</div>}
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* SPECTRUM */}
            <div className="shrink-0 border-b border-gray-800 bg-black">
              <div id="spectrum-area" className="relative w-full" style={{height:'min(15vh, 120px)'}}>
                {/* factor chips */}
                <div className="absolute top-2 left-2 right-2 z-20 flex flex-wrap gap-1 pointer-events-none max-h-[58px] overflow-hidden">
                  {unlockedFactors.map(f => (
                    <div key={f.id} className="bg-black/80 border border-white/20 rounded px-1.5 py-0.5 flex items-center gap-1">
                      <span className="w-1.5 h-1.5 rounded-full" style={{backgroundColor:f.color}}></span>
                      <span className="text-[9px] font-bold text-white leading-none">{f.name}</span>
                    </div>
                  ))}
                </div>

                <WaveCanvas unlockedFactors={unlockedFactors} />
                <OpportunityCanvas opportunities={opps} />
              </div>

              {/* ACTION ROW (BOTTOM of spectrum block) */}
              {state.discoveredFactorIds.includes('alphaomega') && (
                <div id="action-area" className="w-full bg-[#0b0f19] border-t border-gray-800 flex items-stretch justify-between gap-2 px-2 py-2">
                  <ActionButton
                    icon="ğŸŒ"
                    label="ãƒªãƒãƒ¼ã‚¹"
                    sub={state.region === 0 ? 'åœ°çƒâ†’æƒ‘æ˜Ÿ1' : `æƒ‘æ˜Ÿ${state.region + 1}â†’${state.region + 2}`}
                    onClick={onReverse}
                    tone="blue"
                    highlight={guidance?.highlight==='action-reverse'}
                  />
                </div>
              )}

              {/* TABS (no overlap, no syntax bug) */}
              <div className="flex text-[11px] font-bold border-t border-gray-800 font-mono bg-gray-900">
                {tabs.map(t => {
                  const active = activeTab===t;
                  const hl = guidance?.highlight===`tab-${t}`;
                  return (
                    <button
                      key={t}
                      onClick={() => setActiveTab(t)}
                      className={`relative flex-1 py-3 transition-colors uppercase ${active ? 'text-white bg-blue-900/30 border-t-2 border-blue-500' : 'text-slate-400 border-t-2 border-transparent'} ${hl ? 'hl' : ''}`}
                    >
                      {tabLabel(t)}
                      {hl && <div className="arrow">ğŸ‘‡</div>}
                    </button>
                  );
                })}
              </div>
            </div>

            {/* LIST */}
            <div className="flex-1 overflow-y-auto p-3 space-y-3 bg-[#0f172a] pb-20">
              {UPGRADES.filter(u => u.category===activeTab).map(u => {
                const lvl = state.levels[u.id]||0;

                // æˆ¦ç•¥ã®ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’åˆ¤å®šï¼ˆè¡¨ç¤ºã¯ã™ã‚‹ãŒã€å¿…è¦ãªãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ãŒç™ºè¦‹ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ­ãƒƒã‚¯ï¼‰
                const isLockedByFactor = u.category==='strategy' && !u.autoUpgrade && u.reqFactor && !state.discoveredFactorIds.includes(u.reqFactor);
                
                // ãƒªãƒãƒ¼ã‚¹ãŒå¿…è¦ãªã‚¢ã‚¤ãƒ†ãƒ ã¯å¸¸ã«è¡¨ç¤ºï¼ˆãƒ­ãƒƒã‚¯çŠ¶æ…‹ã§ï¼‰
                // reqRegionãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤ºã™ã‚‹ãŒã€è³¼å…¥ã¯ã§ããªã„

                // æŒ‡æ•°é–¢æ•°çš„æˆé•·ã‚’è€ƒæ…®ã—ãŸã‚³ã‚¹ãƒˆè¨ˆç®—
                const isTutorialComplete = state.region === 0 && (state.levels.index_fund || 0) > 0;
                const growthMultiplier = calcExponentialGrowth(1, state.discoveredFactorIds.length, state.region, isTutorialComplete);
                const costGrowth = (u.category === 'strategy' && (isTutorialComplete || state.region > 0)) ? growthMultiplier : 1.0;
                let costA = calcCost(u.baseCostAum || 0, u.costFactor, lvl);
                let costR = calcCost(u.baseCostResearch || 0, u.costFactor, lvl);
                if(costGrowth > 1.0) {
                  costA *= costGrowth;
                  costR *= costGrowth;
                }
                const isLockedByRegion = u.reqRegion !== undefined && state.region < u.reqRegion;
                const can = !isLockedByRegion && state.aum>=costA && state.research>=costR;

                const hlCard = guidance?.highlight===`card-${u.id}`;
                const hlBuy = guidance?.highlight===`buy-${u.id}`;

                const maxBuy = calcMaxBuy(u);
                const canBuy1 = !isLockedByFactor && !isLockedByRegion && state.aum>=costA && state.research>=costR;

                // ç¾åœ¨ã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã¨è³¼å…¥å¾Œã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’è¨ˆç®—
                let currentSpeed = null;
                let afterSpeed = null;
                // ãƒ•ã‚¡ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒã§ã‚‚ã‚‰ãˆã‚‹é‡‘é¡ï¼ˆç¾åœ¨ã¨è³¼å…¥å¾Œï¼‰
                let currentLaunchValue = null;
                let afterLaunchValue = null;
                
                if(!u.autoUpgrade && canBuy1) {
                  const currentRates = calcRates(state);
                  const afterState = { ...state, levels: { ...state.levels, [u.id]: lvl + 1 } };
                  const afterRates = calcRates(afterState);
                  
                  if(u.category === 'data') {
                    currentSpeed = currentRates.dataProd;
                    afterSpeed = afterRates.dataProd;
                  } else if(u.category === 'research') {
                    currentSpeed = currentRates.resProd;
                    afterSpeed = afterRates.resProd;
                  } else if(u.category === 'strategy') {
                    currentSpeed = currentRates.passive * 100; // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤º
                    afterSpeed = afterRates.passive * 100;
                    // ãƒ•ã‚¡ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒã§ã‚‚ã‚‰ãˆã‚‹é‡‘é¡ã‚’è¨ˆç®—ï¼ˆãƒªãƒãƒ¼ã‚¹ä¹—æ•°ã‚’è€ƒæ…®ï¼‰
                    const regionMultiplier = state.region > 0 ? Math.pow(2.0, state.region) : 1.0;
                    currentLaunchValue = calcValue(u.baseValue || 1, lvl) * regionMultiplier;
                    afterLaunchValue = calcValue(u.baseValue || 1, lvl + 1) * regionMultiplier;
                  }
                }

                // ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ã‚’åæ˜ ã—ãŸå®Ÿéš›ã®é€Ÿåº¦ã‚’è¨ˆç®—
                const currentDataRate = u.category === 'data' && !u.autoUpgrade ? (u.effectVal || 0) * lvl : 0;
                const currentResearchRate = u.category === 'research' && !u.autoUpgrade ? (u.outputResearch || 0) * lvl : 0;
                const currentResearchCons = u.category === 'research' && !u.autoUpgrade ? (u.inputNoise || 0) * lvl : 0;
                
                const footerLeft = u.category==='strategy' && !u.autoUpgrade
                  ? (isLockedByFactor ? 'ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­' : `ãƒ•ã‚¡ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒ: ğŸ’°${fmt(currentLaunchValue || calcValue(u.baseValue || 1, lvl) * (state.region > 0 ? Math.pow(2.0, state.region) : 1.0))}`)
                  : u.category==='research' && !u.autoUpgrade
                    ? `ãƒ‡ãƒ¼ã‚¿â†’ãƒªã‚µãƒ¼ãƒ  +${fmt(currentResearchRate)}ğŸ”¬/s  (æ¶ˆè²» ${fmt(currentResearchCons)}ğŸ’¾/s)`
                    : u.category==='data' && !u.autoUpgrade
                      ? `+${fmt(currentDataRate)} ğŸ’¾/s`
                      : u.autoUpgrade
                        ? `ãƒªãƒãƒ¼ã‚¹${u.reqRegion}å›ã§è§£æ”¾`
                        : '';
                const canBuyMax = !isLockedByFactor && !isLockedByRegion && maxBuy > 0;

                return (
                  <div
                    key={u.id}
                    className={`flex flex-col rounded-xl border ${canBuy1 ? 'bg-gray-800 border-blue-500/30' : 'bg-gray-900/50 border-gray-800 opacity-75'} ${hlCard ? 'hl' : ''}`}
                  >
                    <div className="p-2 flex justify-between items-center">
                      <div className="flex gap-3 items-center">
                        <div className="text-2xl w-8 text-center">{u.icon}</div>
                        <div>
                          <div className="font-bold text-sm text-gray-200">{u.name} <span className="text-[10px] text-gray-500 ml-1">{lvl > 0 ? `Lv.${lvl}` : u.reqRegion !== undefined && state.region < u.reqRegion ? `ğŸ”’ æƒ‘æ˜Ÿ${u.reqRegion}ã§è§£æ”¾` : isLockedByFactor ? `ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­` : 'ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­'}</span></div>
                          <div className="text-[10px] text-gray-400 leading-tight">{u.desc}</div>
                          {isLockedByFactor && u.reqFactor && (() => {
                            const requiredFactor = FACTORS.find(f => f.id === u.reqFactor);
                            return requiredFactor ? (
                              <div className="text-[10px] text-orange-400 mt-1 font-bold">
                                ğŸ”’ {requiredFactor.name}ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã®ç™ºè¦‹ãŒå¿…è¦
                              </div>
                            ) : null;
                          })()}
                        </div>
                      </div>
                    </div>
                    <div className="px-2 py-2 bg-black/20 border-t border-white/5 flex justify-between items-center text-[10px] font-mono">
                      <div className="flex flex-col gap-1">
                        <div className="text-gray-300">{footerLeft}</div>
                        {currentSpeed !== null && afterSpeed !== null && (
                          <div className="text-gray-400">
                            {u.category === 'data' && `ğŸ’¾ ${fmt(currentSpeed)}/s â†’ ${fmt(afterSpeed)}/s`}
                            {u.category === 'research' && `ğŸ”¬ ${fmt(currentSpeed)}/s â†’ ${fmt(afterSpeed)}/s`}
                            {u.category === 'strategy' && (
                              <>
                                {currentLaunchValue !== null && afterLaunchValue !== null && (
                                  <div>ğŸ’° {fmt(currentLaunchValue)} â†’ {fmt(afterLaunchValue)}</div>
                                )}
                                <div>ğŸ“ˆ {currentSpeed.toFixed(3)}%/s â†’ {afterSpeed.toFixed(3)}%/s</div>
                              </>
                            )}
                          </div>
                        )}
                      </div>
                      <div className="flex gap-2">
                        {costA>0 && <span className={state.aum>=costA?'text-gray-300':'text-red-400'}>ğŸ’°{fmt(costA)}</span>}
                        {costR>0 && <span className={state.research>=costR?'text-blue-300':'text-red-400'}>ğŸ”¬{fmt(costR)}</span>}
                      </div>
                    </div>
                    <div className="px-2 py-2 border-t border-white/5 flex gap-2">
                      <button
                        onClick={(e) => { e.stopPropagation(); if(canBuy1) buy(u, 1); }}
                        disabled={!canBuy1}
                        className={`flex-1 py-1.5 px-2 rounded-lg text-[10px] font-mono font-bold transition-all relative ${canBuy1 ? 'bg-blue-600 text-white active:scale-[0.98]' : 'bg-gray-800 text-gray-500 cursor-not-allowed'} ${hlBuy ? 'hl' : ''}`}
                      >
                        {u.category === 'strategy' ? 'é–‹ç™ºÃ—1' : 'è³¼å…¥Ã—1'}
                        {hlBuy && <div className="arrow">ğŸ‘‡</div>}
                      </button>
                      <button
                        onClick={(e) => { e.stopPropagation(); if(canBuyMax) buy(u, maxBuy); }}
                        disabled={!canBuyMax}
                        className={`flex-1 py-1.5 px-2 rounded-lg text-[10px] font-mono font-bold transition-all ${canBuyMax ? 'bg-green-600 text-white active:scale-[0.98]' : 'bg-gray-800 text-gray-500 cursor-not-allowed'}`}
                      >
                        {u.category === 'strategy' ? `MAXé–‹ç™º(${maxBuy})` : `MAXè³¼å…¥(${maxBuy})`}
                      </button>
                    </div>
                    {hlCard && <div className="arrow">ğŸ‘‡</div>}
                  </div>
                );
              })}
            </div>

            {/* FX */}
            {flys.map(p => <Flying key={p.id} {...p} />)}
            {floats.map(f => (
              <div key={f.id} className="float" style={{left:f.x, top:f.y, color:f.color, fontSize:f.fontSize}}>{f.text}</div>
            ))}

            {/* Guidance bar */}
            {guidance && (
              <div 
                className={`guidance-bar fixed bottom-0 left-0 right-0 bg-gradient-to-r from-yellow-500/95 via-orange-500/95 to-yellow-500/95 border-t-4 border-yellow-400 py-3 px-2 z-50 flex items-center justify-center gap-2 backdrop-blur-sm min-h-[60px] ${guidance.skipable ? 'cursor-pointer active:scale-[0.99] transition-transform' : ''}`}
                onClick={() => {
                  if(!guidance.skipable) return;
                  // factor-gauge-explanation check
                  if(guidance.skipKey === 'factor-gauge-explanation' && !state.discoveredFactorIds.includes('beta')) return;

                  if(guidance.skipKey) {
                    setGuidanceSkipped(prev => new Set([...prev, guidance.skipKey]));
                    // ã‚¹ã‚­ãƒƒãƒ—æ™‚ã«æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€ãŸã‚ã®æ¡ä»¶ã‚’æº€ãŸã™
                    if(guidance.skipKey === 'auto-data-explanation') {
                      // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³è³¼å…¥å¾Œã®DATAèª¬æ˜ã‚’ã‚¹ã‚­ãƒƒãƒ— â†’ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€
                      setState(p => ({...p, noise: Math.max(p.noise || 0, 10)}));
                    } else if(guidance.skipKey === 'research-explanation') {
                      // ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆèª¬æ˜ã‚’ã‚¹ã‚­ãƒƒãƒ— â†’ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€ï¼ˆresearchã‚’10ä»¥ä¸Šã«ï¼‰
                      setState(p => ({...p, research: Math.max(p.research || 0, 10)}));
                    } else if(guidance.skipKey === 'factor-gauge-explanation') {
                      // ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã‚²ãƒ¼ã‚¸èª¬æ˜ã‚’ã‚¹ã‚­ãƒƒãƒ— â†’ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€ï¼ˆresearchã‚’20ã«è¿‘ã¥ã‘ã‚‹ï¼‰
                      setState(p => ({...p, research: Math.max(p.research || 0, 19)}));
                    } else if(guidance.skipKey === 'aum-explanation') {
                      // é‹ç”¨è³‡ç”£èª¬æ˜ã‚’ã‚¹ã‚­ãƒƒãƒ— â†’ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€
                      setState(p => ({...p, aum: Math.max(p.aum || 0, 1500)}));
                    } else if(guidance.skipKey === 'aum-growth-confirm') {
                      // é‹ç”¨è³‡ç”£å¢—åŠ ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ— â†’ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€
                      setState(p => ({...p, aum: Math.max(p.aum || 0, 2000)}));
                    } else if(guidance.skipKey === 'market-event-diversification') {
                      // ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚¬ã‚¤ãƒ€ãƒ³ã‚¹å®Œäº† â†’ ä»Šå¾Œè¡¨ç¤ºã—ãªã„
                      setMarketEventGuidanceActive(false);
                      setMarketEventGuidanceDone(true);
                    } else if(guidance.skipKey === 'tutorial-complete') {
                      // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ— â†’ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                      const x = window.innerWidth/2;
                      const y = window.innerHeight/2;
                      setModal({
                        title: 'ğŸ“ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†ï¼ ğŸ“',
                        body: `ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼

ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸã€‚

ã“ã®ã‚ˆã†ã«å¸‚å ´ã®ä»•çµ„ã¿ï¼ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã‚’è§£æ˜ã—ã¦ã„ãã€
ã©ã‚“ã©ã‚“ãƒ•ã‚¡ãƒ³ãƒ‰ã§ãŠé‡‘ã‚’é›†ã‚ã€
ä¸–ç•Œä¸€ã®é‹ç”¨ä¼šç¤¾ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ï¼

ğŸš€ ã‚²ãƒ¼ãƒ ã‚’æ¥½ã—ã‚“ã§ãã ã•ã„ï¼`,
                        buttonText: 'ğŸš€ ã‚²ãƒ¼ãƒ é–‹å§‹',
                        icon: 'ğŸŒŸ',
                        onConfirm: () => setModal(null)
                      });
                      setTimeout(() => spawnFloat('ğŸŒŸ', '#fbbf24', x, y), 100);
                      setTimeout(() => spawnFloat('TUTORIAL COMPLETE!', '#4ade80', x, y + 30), 200);
                    }
                  }
                }}
              >
                <span className="text-2xl animate-pulse shrink-0">ğŸ’¡</span>
                <span className="text-sm font-bold text-gray-900 tracking-wide text-center px-1 drop-shadow-[0_2px_4px_rgba(0,0,0,0.3)] break-words leading-relaxed flex-1">
                  {guidance.text}
                  {guidance.skipable && (
                    <span className="block text-[10px] opacity-60 font-normal mt-1">
                      {guidance.skipKey === 'factor-gauge-explanation' && !state.discoveredFactorIds.includes('beta') 
                        ? '(Betaç™ºè¦‹ã§é€²è¡Œ)' 
                        : 'ï¼ˆã‚¿ãƒƒãƒ—ã—ã¦æ¬¡ã¸ï¼‰'}
                    </span>
                  )}
                </span>
                {!guidance.skipable && <span className="text-2xl animate-pulse shrink-0">ğŸ‘‰</span>}
              </div>
            )}

            {modal && <Modal {...modal} onConfirm={() => { modal.onConfirm?.(); setModal(null); }} />}
          </div>
        </ErrorBoundary>
      );
    }

    // Initialize React with fallback for compatibility
    const rootElement = document.getElementById('root');
    if (rootElement) {
      try {
        if (ReactDOM.createRoot) {
          const root = ReactDOM.createRoot(rootElement);
          root.render(<App />);
        } else {
          // Fallback for React 17
          ReactDOM.render(<App />, rootElement);
        }
      } catch (error) {
        console.error('React initialization error:', error);
        rootElement.innerHTML = '<div style="padding: 20px; color: red;">Initialization Error: ' + error.message + '</div>';
      }
    }
  </script>
</body>
</html>
